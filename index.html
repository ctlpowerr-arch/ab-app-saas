<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AB-AP V4.1: Sales and Stock Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.24/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="app.js"></script>
    <style>
        :root {
            --soft-bg: #f8fafc;
            --soft-glass: rgba(255, 255, 255, 0.9);
            --text-dark: #2d3748;
            --text-light: #4a5568;
            --primary-accent: #667eea;
            --secondary-accent: #764ba2;
            --danger-color: #fc8181;
            --success-color: #68d391;
            --warning-color: #f6ad55;
            --info-color: #63b3ed;
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            --hover-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            #categories-section {
                order: -1;
            }
            #products-section {
                order: 0;
            }
            .categories-products-container {
                display: flex;
                flex-direction: column;
            }
        }

        @media (max-width: 576px) {
            .navbar-brand {
                font-size: 0.85rem;
            }
            #categories-section {
                order: -1 !important;
                margin-bottom: 1.5rem;
            }
            #products-section {
                order: 0 !important;
            }
            .form-section {
                margin-bottom: 1rem;
            }
            .navbar-toggler {
                margin-left: auto !important;
            }
            .navbar-collapse {
                margin-top: 0.5rem;
            }
            .navbar-nav {
                flex-direction: row;
                gap: 0.5rem;
            }
        }
        :root.dark-mode {
            --soft-bg: #1a202c;
            --soft-glass: rgba(30, 41, 59, 0.9);
            --text-dark: #e2e8f0;
            --text-light: #cbd5e1;
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            --hover-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        :root.dark-mode .navbar-light {
            background-color: rgba(30, 41, 59, 0.95) !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        :root.dark-mode .fixed-bottom-nav {
            background: rgba(30, 41, 59, 0.95);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
        }
        body {
            background: linear-gradient(135deg, var(--soft-bg) 0%, #e2e8f0 100%);
            color: var(--text-dark);
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            line-height: 1.6;
            padding-bottom: 70px;
        }
        .glass-card, .glass-modal-content {
            background: var(--soft-glass);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }
        .chart-container { position: relative; height: 40vh; width: 100%; min-height: 300px; }
        .chart-container-small { position: relative; height: 350px; width: 100%; }
        .navbar-light { 
            background-color: rgba(255, 255, 255, 0.95) !important; 
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .fixed-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 65px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.08);
            z-index: 1020;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 5px;
        }
        .fixed-bottom-nav .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 0.75rem;
            font-weight: 500;
            padding: 5px;
            transition: color 0.3s ease, transform 0.2s ease;
        }
        .fixed-bottom-nav .nav-link i {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }
        .fixed-bottom-nav .nav-link.active,
        .fixed-bottom-nav .nav-link:hover {
            color: var(--primary-accent);
            transform: translateY(-2px);
        }
        .btn-glass { 
            background: linear-gradient(135deg, var(--primary-accent) 0%, var(--secondary-accent) 100%);
            border: none;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            border-radius: 12px;
        }
        .btn-glass:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }
        .btn-glass-secondary {
            background: linear-gradient(135deg, var(--secondary-accent) 0%, var(--primary-accent) 100%);
            border: none;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
            border-radius: 12px;
        }
        .btn-glass-secondary:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(118, 75, 162, 0.4);
            color: white;
        }
        .kpi-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .text-negative-margin {
            color: var(--danger-color);
        }
        .kpi-critical {
            border: 2px solid var(--danger-color);
            box-shadow: 0 0 10px rgba(252, 129, 129, 0.5);
        }
        .product-image-preview-sm {
            height: 35px;
            width: 35px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid var(--primary-accent);
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-accent) 0%, var(--secondary-accent) 100%);
            padding: 20px;
        }
        .login-card {
            width: 100%;
            max-width: 420px;
            padding: 3rem;
            border-radius: 1.5rem;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .quick-sale-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success-color) 0%, var(--info-color) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 8px 25px rgba(104, 211, 145, 0.5);
            z-index: 1030; 
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .quick-sale-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(104, 211, 145, 0.7);
        }
        @media (max-width: 768px) {
            .container-xl {
                padding: 0 10px;
            }
            .glass-card {
                margin-bottom: 1rem;
                padding: 1rem !important;
            }
            .kpi-value {
                font-size: 1.4rem !important;
            }
            .table-responsive {
                font-size: 0.8rem;
            }
            #dashboard-container-kpis .col-6 { 
                flex: 0 0 auto;
                width: 50%;
            }
            .btn, .btn-glass, .btn-glass-secondary {
                font-size: 0.9rem !important;
                padding: 0.5rem 1rem !important;
            }
            .btn-sm {
                font-size: 0.8rem !important;
                padding: 0.3rem 0.6rem !important;
            }
        }
        @media (max-width: 576px) {
            .d-md-inline { display: none !important; }
            .chart-container, .chart-container-small { height: 250px !important; }
            .display-6 { font-size: 1.5rem; }
            .btn, .btn-glass, .btn-glass-secondary {
                font-size: 0.85rem !important;
                padding: 0.4rem 0.8rem !important;
                width: 100% !important;
            }
            .btn-sm {
                font-size: 0.75rem !important;
                padding: 0.25rem 0.5rem !important;
                width: auto !important;
            }
            .navbar-brand { font-size: 0.9rem !important; }
            .fixed-bottom-nav .nav-link {
                font-size: 0.525rem !important; /* Réduction de 30% de 0.75rem */
            }
            .security-badge { display: none; }
            .table { font-size: 0.75rem !important; }
        }
        .security-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--success-color);
            color: white;
        }
        /* Styles pour la facture */
        .invoice-container {
            display: none; /* Caché par défaut */
            width: 210mm; /* Format A4 */
            min-height: 297mm;
            margin: 0 auto;
            padding: 10mm 15mm;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            font-family: 'Open Sans', 'Helvetica Neue', Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.5;
        }
        .invoice {
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        .watermark-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-25deg);
            font-family: 'Playfair Display', serif;
            font-size: 5em;
            font-weight: bold;
            color: #000;
            opacity: 0.05;
            text-shadow: none;
            pointer-events: none;
            white-space: nowrap;
            z-index: 1;
        }
        .invoice-header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .invoice-header h2 {
            margin: 0;
            font-size: 1.8em;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
        }
        .invoice-header .description {
            font-style: italic;
            font-size: 0.85em;
            margin: 5px 0 5px 0;
            color: #666;
        }
        .invoice-header p {
            margin: 0;
            font-size: 0.75em;
            line-height: 1.3;
            color: #555;
        }
        .invoice-info {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            padding-left: 5px;
            padding-right: 5px;
        }
        .invoice-info div {
            display: flex;
            width: 100%;
            margin-bottom: 3px;
        }
        .invoice-info dt {
            font-weight: bold;
            width: 30%;
            color: #555;
        }
        .invoice-info dd {
            width: 70%;
            margin-left: 0;
            text-align: right;
            color: #333;
        }
        .invoice-info dt, .invoice-info dd {
            font-size: 0.85em;
        }
        .articles-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .articles-table th, .articles-table td {
            text-align: right;
            padding: 5px 5px;
        }
        .articles-table th:first-child, .articles-table td:first-child {
            text-align: left;
            width: 25%;
        }
        .articles-table th:nth-child(2), .articles-table td:nth-child(2) {
            text-align: left;
            width: 35%;
        }
        .articles-table th:nth-child(3), .articles-table td:nth-child(3) {
            width: 15%;
        }
        .articles-table th:nth-child(4), .articles-table td:nth-child(4) {
            width: 10%;
        }
        .articles-table th:nth-child(5), .articles-table td:nth-child(5) {
            width: 15%;
        }
        .articles-table th {
            border-bottom: 1px solid #999;
            font-weight: bold;
            padding-bottom: 5px;
            text-transform: uppercase;
            color: #333;
        }
        .articles-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #ccc;
            font-weight: bold;
            font-size: 1em;
        }
        .item-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.95em;
        }
        .important-note {
            margin: 15px 0;
            padding: 8px;
            border-left: 3px solid #666;
            background-color: #f0f0f0;
            font-size: 0.8em;
            text-align: left;
            color: #444;
            line-height: 1.4;
        }
        .signature-area {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 10px;
        }
        .signature-block {
            width: 45%;
            text-align: center;
            border-top: 1px dashed #999;
            padding-top: 5px;
            font-size: 0.8em;
            color: #555;
        }
        .invoice-footer {
            border-top: 1px dashed #ddd;
            padding-top: 10px;
            text-align: center;
            font-size: 0.75em;
            color: #777;
        }
        .invoice-button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 10px;
        }
        .invoice-action-button {
            padding: 12px;
            border: none;
            cursor: pointer;
            color: white;
            font-weight: bold;
            font-size: 1.05em;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        .invoice-download-button { flex-grow: 1; background: #e67e22; }
        .invoice-print-button { flex-grow: 1; background: #3498db; }
        .invoice-share-button { flex-grow: 1; background: #2ecc71; }
        .invoice-share-menu {
            position: absolute;
            top: 100%;
            right: 0;
            width: 300px;
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 20;
            display: none;
            border-radius: 4px;
            overflow: hidden;
        }
        .invoice-share-menu.active { display: block; }
        .invoice-share-menu-item {
            padding: 10px 15px;
            text-align: left;
            cursor: pointer;
            color: #333;
            border-bottom: 1px solid #eee;
        }
        /* Overlay pour la validation de vente */
        .sale-validation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .sale-validation-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .sale-validation-content i {
            font-size: 3em;
            color: var(--success-color);
            margin-bottom: 15px;
        }
        /* Carousel des dettes */
        .debt-carousel-container {
            max-height: 200px;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
        }
        .debt-carousel-item {
            padding: 10px 15px;
            background-color: var(--soft-glass);
            color: var(--text-dark);
            font-weight: 500;
        }
        .debt-carousel-item .client-name {
            font-weight: bold;
            color: var(--primary-accent);
        }
        /* Section Historique des tâches */
        #task-history-password-modal .modal-content {
            background: var(--soft-glass);
            backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 1.5rem;
        }
    </style>
</head>
<body>
<div id="login-page">
    <div class="login-container">
        <div class="login-card text-center">
            <div class="mb-4">
                <i class="fas fa-shield-alt fa-3x mb-3" style="color: var(--primary-accent);"></i>
                <h1 class="h3 mb-2" style="color: var(--text-dark);">AB-APP V4.1</h1>
                <p class="text-muted">Connexion Sécurisée</p>
            </div>
            <div id="login-alert" class="alert alert-danger d-none" role="alert"></div>
            <form id="login-form">
                <div class="mb-3">
                    <input type="text" class="form-control form-control-lg" id="login-username" 
                           placeholder="Nom d'utilisateur" required autocomplete="username">
                </div>
                <div class="mb-4">
                    <input type="password" class="form-control form-control-lg" id="login-password" 
                           placeholder="Mot de passe" required autocomplete="current-password">
                    <div class="form-text text-start">
                        <i class="fas fa-info-circle"></i> Secure password required
                    </div>
                </div>
                <button type="submit" class="btn btn-glass w-100 btn-lg" id="login-btn">
                    <i class="fas fa-lock me-2"></i> Sign In
                </button>
            </form>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-shield-alt me-1"></i>
                    Secured session • Data saved online
                </small>
            </div>
        </div>
    </div>
</div>
<div id="app-container" style="display: none;">
    <!-- Message de bienvenue -->
    <div id="welcome-message" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(240, 240, 240, 0.9); z-index: 1050; justify-content: center; align-items: center;">
        <div class="glass-card welcome-card p-5 text-center">
            <i class="fas fa-rocket fa-3x mb-3" style="color: var(--primary-accent);"></i>
            <h1 class="display-4 mb-3" id="welcome-title">Bienvenue, Utilisateur AB-APP !</h1>
            <p class="lead mb-4">Votre plateforme de gestion intelligente est prête.</p>
            <button class="btn btn-glass btn-lg" onclick="hideWelcomeMessage()">
                <i class="fas fa-play-circle me-2"></i> Get Started
            </button>
        </div>
    </div>
    <!-- Header amélioré -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center flex-shrink-1" href="#" onclick="showPage('dashboard')" style="min-width: 0;">
                <img src="" id="nav-logo" class="me-2 rounded-circle border border-2 flex-shrink-0" style="height: 35px; width: 35px; object-fit: cover; display: none; border-color: var(--primary-accent) !important;">
                <div style="min-width: 0;">
                    <span id="company-name-display" class="fw-bold d-block" style="color: var(--primary-accent); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ALPHA PRO</span>
                    <small class="text-muted d-none d-sm-block" id="company-slogan" style="font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Gestion Intelligente</small>
                </div>
            </a>
            <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" style="border: none; padding: 0.25rem 0.5rem;">
                <i class="fas fa-bars" style="color: var(--primary-accent); font-size: 1.2rem;"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto gap-1">
                <li class="nav-item">
                    <button id="dark-mode-toggle" class="btn btn-sm btn-outline-secondary" onclick="toggleDarkMode()" title="Toggle Dark Mode" style="border: 1px solid #ccc; padding: 0.3rem 0.6rem;">
                        <i class="fas fa-moon"></i>
                    </button>
                </li>
                <li class="nav-item d-none d-md-block">
                    <span class="security-badge">
                        <i class="fas fa-lock me-1"></i>Secure
                    </span>
                </li>
                <li class="nav-item">
                    <button id="notification-button-top" class="btn btn-sm btn-outline-info position-relative" data-bs-toggle="offcanvas" data-bs-target="#notificationCanvas" style="padding: 0.3rem 0.6rem;">
                        <i class="fas fa-bell"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-counter" style="display: none; font-size: 0.6rem;">0</span>
                    </button>
                </li>
                <li class="nav-item dropdown">
                    <button class="btn btn-sm btn-glass dropdown-toggle" id="settings-menu" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-1"></i> <span class="d-none d-md-inline" id="current-user-display">Compte</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end glass-modal-content">
                        <li><a class="dropdown-item text-primary-accent" href="#" onclick="showPage('settings')"><i class="fas fa-cog me-2"></i> Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="changeLanguage('en')"><i class="fas fa-globe me-2"></i> English</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeLanguage('fr')"><i class="fas fa-globe me-2"></i> Français</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                    </ul>
                </li>
            </ul>
            </div>
        </div>
    </nav>
    <!-- Navigation du bas -->
    <div class="fixed-bottom-nav">
        <a href="#" class="nav-link active" onclick="showPage('dashboard')">
            <i class="fas fa-tachometer-alt"></i>
            <span data-i18n="Tableau de Bord">Tableau de Bord</span>
        </a>
        <a href="#" class="nav-link" onclick="showPage('categories')">
            <i class="fas fa-box-open"></i>
            <span data-i18n="Produits">Produits</span>
        </a>
        <a href="#" class="nav-link" onclick="showPage('clients')">
            <i class="fas fa-users"></i>
            <span data-i18n="Clients">Clients</span>
        </a>
        <a href="#" class="nav-link" onclick="showPage('sales-management')">
            <i class="fas fa-chart-line"></i>
            <span data-i18n="Ventes">Ventes</span>
        </a>
        <a href="#" class="nav-link" onclick="showPage('invoices-management')">
            <i class="fas fa-file-invoice"></i>
            <span data-i18n="Factures">Factures</span>
        </a>
        <a href="#" class="nav-link" onclick="showPage('analytics')">
            <i class="fas fa-chart-bar"></i>
            <span data-i18n="Analyses">Analyses</span>
        </a>
        <a href="#" class="nav-link" onclick="showPage('task-history')">
            <i class="fas fa-history"></i>
            <span data-i18n="Historique des Tâches">Historique des Tâches</span>
        </a>
    </div>
    <!-- Bouton de vente rapide -->
    <div class="quick-sale-btn" onclick="openNewSaleModal()">
        <i class="fas fa-plus"></i>
    </div>
    <!-- Panneau des notifications -->
    <div class="offcanvas offcanvas-end glass-modal-content" tabindex="-1" id="notificationCanvas">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" style="color: var(--secondary-accent);">
                <i class="fas fa-bell me-2"></i> Notifications
            </h5>
            <button type="button" class="btn-close text-reset" data-bs-toggle="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div class="d-flex justify-content-between mb-3">
                <button class="btn btn-sm btn-outline-secondary" onclick="markAllNotificationsRead()">
                    <i class="fas fa-check-double me-1"></i> Mark all as read
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="clearAllNotifications()">
                    <i class="fas fa-trash me-1"></i> Delete all
                </button>
            </div>
            <div id="notification-list">
                <p class="text-muted text-center">Aucune notification</p>
            </div>
        </div>
    </div>
    <!-- Contenu principal -->
    <main class="container-fluid mt-4">
        <!-- Dashboard -->
        <div id="dashboard" class="page-content container-xl" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row">
                <h1 class="display-6 mb-3 mb-md-0" style="color: var(--primary-accent);">Tableau de Bord</h1>
                <div class="btn-group">
                    <button class="btn btn-sm btn-glass" onclick="exportDashboardPDF()">
                        <i class="fas fa-file-pdf me-1"></i> <span class="d-none d-md-inline">PDF</span>
                    </button>
                    <button class="btn btn-sm btn-glass-secondary" onclick="exportDataToCSV()">
                        <i class="fas fa-file-csv me-1"></i> <span class="d-none d-md-inline">CSV</span>
                    </button>
                    <button class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                        <i class="fas fa-filter me-1"></i> <span class="d-none d-md-inline">Filtres</span>
                    </button>
                </div>
            </div>
            <!-- Filtres -->
            <div class="collapse mb-4" id="filterCollapse">
                <div class="glass-card p-3">
                    <h5 class="text-dark mb-3"><i class="fas fa-sliders-h me-2"></i> Advanced Filters</h5>
                    <div class="row g-3" id="dashboard-filter-form">
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label">Date de début</label>
                            <input type="date" class="form-control" id="filter-date-start" onchange="updateDashboard()">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label">Date de fin</label>
                            <input type="date" class="form-control" id="filter-date-end" onchange="updateDashboard()">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label">Catégorie</label>
                            <select class="form-select" id="filter-category" onchange="updateDashboard()">
                                <option value="all">Tout</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label">Product</label>
                            <select class="form-select" id="filter-product" onchange="updateDashboard()">
                                <option value="all">Tout</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Carousel des dettes -->
            <div class="debt-container mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="text-warning mb-0"><i class="fas fa-exclamation-triangle me-2"></i> Current Client Debts</h4>
                    <span class="badge bg-warning" id="debts-count">0</span>
                </div>
                <div class="debt-carousel-container">
                    <div id="debtCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
                        <div class="carousel-inner" id="debt-carousel-inner">
                            <!-- Les items du carousel seront insérés ici par JS -->
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#debtCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Précédent</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#debtCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Suivant</span>
                        </button>
                    </div>
                </div>
            </div>
            <!-- KPIs -->
            <div class="row" id="dashboard-container-kpis">
                <div class="col-xl-3 col-md-6 col-6 mb-4">
                    <div class="glass-card p-3 text-center">
                        <p class="kpi-title">Bénéfice Net</p>
                        <p class="kpi-value text-success" id="kpi-net-profit">0 FCFA</p>
                        <small class="text-muted"><i class="fas fa-calendar me-1"></i> Period</small>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 col-6 mb-4">
                    <div class="glass-card p-3 text-center">
                        <p class="kpi-title">Chiffre d'Affaires</p>
                        <p class="kpi-value" style="color: var(--secondary-accent);" id="kpi-total-sales">0 FCFA</p>
                        <small class="text-muted"><i class="fas fa-cash-register me-1"></i> <span id="sales-count">0 transactions</span></small>
                    </div>
                </div>
                 <div class="col-xl-3 col-md-6 col-6 mb-4">
                    <div class="glass-card p-3 text-center" id="kpi-low-stock-card">
                        <p class="kpi-title">Stock Critique</p>
                        <p class="kpi-value text-danger" id="kpi-low-stock-count">0 products</p>
                        <small class="text-muted"><i class="fas fa-exclamation-circle me-1"></i> Check Inventory</small>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 col-6 mb-4">
                    <div class="glass-card p-3 text-center">
                        <p class="kpi-title">Dettes Totales</p>
                        <p class="kpi-value text-warning" id="kpi-debts-due">0 FCFA</p>
                        <small class="text-muted"><i class="fas fa-user-clock me-1"></i> <span id="due-count">0 clients</span></small>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 col-6 mb-4">
                    <div class="glass-card p-3 text-center">
                        <p class="kpi-title">Quantité Vendue</p>
                        <p class="kpi-value text-info" id="kpi-qty-sold">0 units</p>
                        <small class="text-muted"><i class="fas fa-cubes me-1"></i> Total</small>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 col-6 mb-4">
                    <div class="glass-card p-3 text-center">
                        <p class="kpi-title">Dépenses (Total)</p>
                        <p class="kpi-value text-danger" id="kpi-total-expenses">0 FCFA</p>
                        <small class="text-muted"><i class="fas fa-money-bill-wave-alt me-1"></i> Period</small>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 col-6 mb-4">
                    <div class="glass-card p-3 text-center">
                        <p class="kpi-title">Marge Brute</p>
                        <p class="kpi-value" style="color: var(--primary-accent);" id="kpi-gross-margin">0 FCFA</p>
                        <small class="text-muted"><i class="fas fa-percent me-1"></i> Before expenses</small>
                    </div>
                </div>
                 <div class="col-xl-3 col-md-6 col-6 mb-4">
                    <div class="glass-card p-3 text-center">
                        <p class="kpi-title">Marge Nette</p>
                        <p class="kpi-value" style="color: var(--success-color);" id="kpi-net-margin">0 FCFA</p>
                        <small class="text-muted"><i class="fas fa-chart-line me-1"></i> After expenses</small>
                    </div>
                </div>
            </div>
            <!-- Graphiques -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="glass-card p-4 chart-container-small">
                        <h5 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-chart-line me-2"></i> Monthly Profits and Expenses</h5>
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="glass-card p-4 chart-container-small">
                        <h5 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-chart-pie me-2"></i> Répartition des Dépenses</h5>
                        <canvas id="expenseCategoryChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="glass-card p-4 chart-container-small">
                        <h5 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-boxes me-2"></i> Stock by Category</h5>
                        <canvas id="stockByCategoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Gestion des produits -->
        <div id="categories" class="page-content container-xl" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6" style="color: var(--primary-accent);">Gestion des Produits</h1>
                <button class="btn btn-glass" onclick="exportProductsToCSV()">
                    <i class="fas fa-file-export me-2"></i> Export Products
                </button>
            </div>
            <div class="row flex-column-reverse flex-lg-row">
                <div class="col-lg-5 mb-4">
                    <div class="glass-card p-4">
                        <h4 class="mb-4" style="color: var(--primary-accent);"><i class="fas fa-box-open me-2"></i> Stock Entry / New Product</h4>
                        <form id="product-inflow-form">
                            <input type="hidden" id="product-id">
                            <div class="mb-3">
                                <label for="inflow-product-name-input" class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="inflow-product-name-input" required>
                            </div>
                            <div class="mb-3">
                                <label for="product-category" class="form-label">Catégorie</label>
                                <select class="form-select" id="product-category" required>
                                    <option value="" disabled selected>Choisir une catégorie</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="product-specs" class="form-label">Caractéristiques (Max 30 chars)</label>
                                <input type="text" class="form-control" id="product-specs" maxlength="30" placeholder="e.g., Black, 128GB, Pro">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="product-buy-price" class="form-label">Prix d'Achat</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="product-buy-price" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="product-sale-price" class="form-label">Prix de Vente</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="product-sale-price" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="product-inflow-qty" class="form-label">Quantité Entrante</label>
                                    <input type="number" min="1" class="form-control" id="product-inflow-qty" value="1" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="product-alert-qty" class="form-label">Qté d'Alerte (Stock Bas)</label>
                                    <input type="number" min="0" class="form-control" id="product-alert-qty" value="0">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="product-image" class="form-label">Image du Produit (Optionnel)</label>
                                <input class="form-control" type="file" id="product-image" accept="image/*" onchange="previewImage('product-image', 'product-image-preview-large')">
                            </div>
                            <div class="mb-4 text-center">
                                <img id="product-image-preview-large" src="#" alt="Product preview" style="max-height: 150px; object-fit: cover; display: none; border-radius: 12px; border: 1px solid #ddd;">
                            </div>
                            <button type="submit" class="btn btn-glass w-100" id="inflow-submit-btn">
                                <i class="fas fa-plus me-2"></i> Add to Stock
                            </button>
                        </form>
                    </div>
                </div>
                <div class="col-lg-7">
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="glass-card p-4">
                                <h5 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-sitemap me-2"></i> Categories</h5>
                                <form id="category-form" class="input-group mb-3">
                                    <input type="hidden" id="category-id">
                                    <input type="text" class="form-control" id="category-name" placeholder="Nom de la catégorie" required>
                                    <button class="btn btn-glass-secondary" type="submit">Ajouter/Modifier</button>
                                </form>
                                <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                    <table class="table table-sm">
                                        <tbody id="categories-table-body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 mb-4">
                            <div class="glass-card p-4">
                                <h5 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-boxes me-2"></i> Current Inventory</h5>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="product-search-input" placeholder="Rechercher un produit..." oninput="renderProductInflow()">
                                </div>
                                <div class="table-responsive" style="max-height: 50vh; overflow-y: auto;">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Image</th>
                                                <th>Nom</th>
                                                <th>Spécifications</th>
                                                <th>Qté</th>
                                                <th>Prix de Vente</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="product-inflow-table-body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Gestion des clients -->
        <div id="clients" class="page-content container-xl" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6" style="color: var(--primary-accent);">Gestion des Clients</h1>
                <button class="btn btn-glass" data-bs-toggle="modal" data-bs-target="#newClientModal">
                    <i class="fas fa-plus-circle me-2"></i> New Client
                </button>
            </div>
            <div class="glass-card p-4 mb-4">
                <h4 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-users me-2"></i> Client List</h4>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="client-search-input" placeholder="Rechercher un client..." oninput="renderClients()">
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Téléphone</th>
                                <th>Email</th>
                                <th>Dettes Actives</th>
                                <th>Achat Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Gestion des ventes -->
        <div id="sales-management" class="page-content container-xl" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6" style="color: var(--primary-accent);">Gestion des Ventes</h1>
                <div class="btn-group">
                    <button class="btn btn-glass" data-bs-toggle="modal" data-bs-target="#newSaleModal">
                        <i class="fas fa-plus-circle me-2"></i> New Sale
                    </button>
                    <button class="btn btn-glass-secondary" onclick="exportSalesToCSV()">
                        <i class="fas fa-file-export me-2"></i> Export Sales
                    </button>
                    <button class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#salesFilterCollapse">
                        <i class="fas fa-filter me-1"></i> Filters
                    </button>
                </div>
            </div>
            <!-- Filtres Ventes -->
            <div class="collapse mb-4" id="salesFilterCollapse">
                <div class="glass-card p-3">
                    <h5 class="text-dark mb-3"><i class="fas fa-search me-2"></i> Search & Filter</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="Filtrer par nom de client..." oninput="renderSales()">
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="Filtrer par nom de produit..." oninput="renderSales()">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" onchange="renderSales()">
                                <option value="all">Tous les Statuts</option>
                                <option value="Espèces">Espèces</option>
                                <option value="Crédit">Crédit</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="glass-card p-4 mb-4">
                <h4 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-history me-2"></i> Sales History</h4>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Produits</th>
                                <th>Qté</th>
                                <th>Prix Total</th>
                                <th>Marge Brute</th>
                                <th>Marge Nette</th>
                                <th>Statut</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Gestion des factures -->
        <div id="invoices-management" class="page-content container-xl" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6" style="color: var(--primary-accent);">Gestion des Factures</h1>
                <button class="btn btn-glass-secondary" onclick="exportInvoicesToCSV()">
                    <i class="fas fa-file-export me-2"></i> Export Invoices
                </button>
            </div>
            <div class="glass-card p-4">
                <h4 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-file-invoice me-2"></i> Generated Invoices</h4>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>N° Facture</th>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="invoices-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Historique des tâches -->
        <div id="task-history" class="page-content container-xl" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6" style="color: var(--primary-accent);">Historique des Tâches</h1>
                <button class="btn btn-glass-secondary" onclick="exportTaskHistoryToCSV()">
                    <i class="fas fa-file-export me-2"></i> Export History
                </button>
            </div>
            <div class="glass-card p-4 mb-4">
                <h4 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-history me-2"></i> Action Log</h4>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="log-date-start" placeholder="Date de début" onchange="renderTaskHistory()">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="log-date-end" placeholder="Date de fin" onchange="renderTaskHistory()">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="log-user-search" placeholder="Filtrer par utilisateur..." oninput="renderTaskHistory()">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="log-action-type" onchange="renderTaskHistory()">
                            <option value="all">Toutes les Actions</option>
                            <option value="add_product">Ajouter un Produit</option>
                            <option value="add_sale">Ajouter une Vente</option>
                            <option value="add_client">Ajouter un Client</option>
                            <option value="delete_sale">Supprimer une Vente</option>
                            <option value="generate_invoice">Générer une Facture</option>
                            <option value="record_payment">Enregistrer un Paiement</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Date & Heure</th>
                                <th>Utilisateur</th>
                                <th>Action</th>
                                <th>Détails</th>
                            </tr>
                        </thead>
                        <tbody id="task-history-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Analytics -->
        <div id="analytics" class="page-content container-xl" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6" style="color: var(--primary-accent);">Analyse des Ventes</h1>
                <div class="btn-group">
                    <button class="btn btn-sm btn-glass" onclick="exportAnalyticsPDF()">
                        <i class="fas fa-file-pdf me-1"></i> PDF
                    </button>
                    <button class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#analyticsFilterCollapse">
                        <i class="fas fa-filter me-1"></i> Filters
                    </button>
                </div>
            </div>
            <!-- Filtres Analytics -->
            <div class="collapse mb-4" id="analyticsFilterCollapse">
                <div class="glass-card p-3">
                    <h5 class="text-dark mb-3"><i class="fas fa-sliders-h me-2"></i> Filtres d'Analyse</h5>
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label">Période</label>
                            <select class="form-select" id="analytics-period" onchange="updateAnalytics()">
                                <option value="7days">7 derniers jours</option>
                                <option value="30days">30 derniers jours</option>
                                <option value="90days">90 derniers jours</option>
                                <option value="year">Cette année</option>
                                <option value="custom">Personnalisé</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label">Date de début</label>
                            <input type="date" class="form-control" id="analytics-date-start" onchange="updateAnalytics()">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label">Date de fin</label>
                            <input type="date" class="form-control" id="analytics-date-end" onchange="updateAnalytics()">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label">Catégorie</label>
                            <select class="form-select" id="analytics-category" onchange="updateAnalytics()">
                                <option value="all">Tout</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Graphiques Analytics -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="glass-card p-4 chart-container-small">
                        <h5 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-chart-line me-2"></i> Sales Evolution</h5>
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="glass-card p-4 chart-container-small">
                        <h5 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-chart-bar me-2"></i> Top Products</h5>
                        <canvas id="topProductsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="glass-card p-4 chart-container-small">
                        <h5 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-user-friends me-2"></i> Top Clients</h5>
                        <canvas id="topClientsChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="glass-card p-4 chart-container-small">
                        <h5 class="mb-3" style="color: var(--secondary-accent);"><i class="fas fa-calendar-alt me-2"></i> Sales by Weekday</h5>
                        <canvas id="salesByWeekdayChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Gestion des dettes -->
        <div id="debts-management" class="page-content container-xl" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6" style="color: var(--primary-accent);">Debt Management</h1>
                <button class="btn btn-glass-secondary" onclick="exportDebtsToCSV()">
                    <i class="fas fa-file-export me-2"></i> Export Debts
                </button>
            </div>
            <div class="glass-card p-4">
                <h4 class="mb-3 text-warning"><i class="fas fa-hand-holding-usd me-2"></i> Current Debts</h4>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Date d'échéance</th>
                                <th>Montant Initial</th>
                                <th>Reste à Payer</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="debts-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Gestion des dépenses -->
        <div id="expenses-management" class="page-content container-xl" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6" style="color: var(--primary-accent);">Expense Management</h1>
                <div class="btn-group">
                    <button class="btn btn-glass-secondary" onclick="exportExpensesToCSV()">
                        <i class="fas fa-file-export me-2"></i> Export Expenses
                    </button>
                    <button class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#expenseFilterCollapse">
                        <i class="fas fa-filter me-1"></i> Filters
                    </button>
                </div>
            </div>
            <!-- Filtres Dépenses -->
            <div class="collapse mb-4" id="expenseFilterCollapse">
                <div class="glass-card p-3">
                    <h5 class="text-dark mb-3"><i class="fas fa-search me-2"></i> Search & Filter</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="Filter by description..." oninput="renderExpenses()">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" onchange="renderExpenses()">
                                <option value="all">All Categories</option>
                                <option value="Rent">Rent</option>
                                <option value="Salaries">Salaries</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Autres">Autres</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="date" class="form-control" placeholder="Filter by date..." onchange="renderExpenses()">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="glass-card p-4">
                         <h4 class="mb-4 text-danger"><i class="fas fa-money-bill-wave-alt me-2"></i> Record an Expense</h4>
                         <form id="expense-form">
                            <input type="hidden" id="expense-id">
                            <div class="mb-3">
                                <label for="expense-description" class="form-label">Description</label>
                                <input type="text" class="form-control" id="expense-description" required>
                            </div>
                            <div class="mb-3">
                                <label for="expense-category" class="form-label">Catégorie</label>
                                <select class="form-select" id="expense-category" required>
                                    <option value="" disabled selected>Choisir une catégorie</option>
                                    <option value="Rent">Rent</option>
                                    <option value="Salaries">Salaries</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Autres">Autres</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="expense-amount" class="form-label">Montant</label>
                                <input type="number" step="0.01" min="0" class="form-control" id="expense-amount" required>
                            </div>
                            <div class="mb-4">
                                <label for="expense-date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="expense-date" required>
                            </div>
                            <button type="submit" class="btn btn-glass w-100">Record Expense</button>
                         </form>
                    </div>
                </div>
                <div class="col-lg-8 mb-4">
                    <div class="glass-card p-4">
                        <h4 class="mb-3 text-danger"><i class="fas fa-list me-2"></i> Expense History</h4>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Catégorie</th>
                                        <th>Montant</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Paramètres -->
        <div id="settings" class="page-content container-xl" style="display: none;">
            <h1 class="display-6 mb-4" style="color: var(--primary-accent);">Application Settings</h1>
            <div class="glass-card p-4">
                <h4 class="mb-4" style="color: var(--primary-accent);"><i class="fas fa-cogs me-2"></i> General Configuration</h4>
                <form id="settings-form">
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="p-3 border rounded">
                                <h6 style="color: var(--secondary-accent);"><i class="fas fa-building me-2"></i> Company Information</h6>
                                <div class="mb-3">
                                    <label for="setting-company-name" class="form-label">Nom de l'Entreprise</label>
                                    <input type="text" class="form-control" id="setting-company-name">
                                </div>
                                <div class="mb-3">
                                    <label for="setting-company-slogan" class="form-label">Slogan</label>
                                    <input type="text" class="form-control" id="setting-company-slogan">
                                </div>
                                <div class="mb-3">
                                    <label for="setting-logo" class="form-label">Logo de l'Entreprise</label>
                                    <input class="form-control" type="file" id="setting-logo" accept="image/*" onchange="previewImage('setting-logo', 'setting-logo-preview')">
                                </div>
                                <div class="text-center">
                                     <img id="setting-logo-preview" src="#" alt="Aperçu du Logo" class="product-image-preview-sm" style="height: 50px; width: 50px; display: none;">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="p-3 border rounded">
                                <h6 style="color: var(--secondary-accent);"><i class="fas fa-globe me-2"></i> Location</h6>
                                <div class="mb-3">
                                    <label for="setting-language" class="form-label">Langue</label>
                                    <select class="form-select" id="setting-language">
                                        <option value="en">Anglais</option>
                                        <option value="fr">Français</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="setting-currency" class="form-label">Symbole Monétaire</label>
                                    <input type="text" class="form-control" id="setting-currency" placeholder="Ex: FCFA, $, €">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="p-3 border rounded">
                                <h6 style="color: var(--secondary-accent);"><i class="fas fa-warehouse me-2"></i> Stock Management</h6>
                                <div class="mb-3">
                                    <label for="setting-low-stock-threshold" class="form-label">Global Low Stock Alert Threshold</label>
                                    <input type="number" min="0" class="form-control" id="setting-low-stock-threshold">
                                    <small class="text-muted">Applies to products without specific threshold.</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="p-3 border rounded bg-light">
                                <h6 class="text-danger"><i class="fas fa-lock me-2"></i> Security</h6>
                                <div class="mb-3">
                                    <label class="form-label">Security Status</label>
                                    <div class="alert alert-success py-2">
                                        <i class="fas fa-shield-alt me-2"></i>
                                        <strong>System secured</strong>
                                        <br>
                                        <small>Data saved online • Access by credentials</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-glass w-100 mt-3">Enregistrer les Paramètres</button>
                </form>
            </div>
            <!-- Section Paramètres de Facturation -->
            <div class="glass-card p-4 mt-4">
                <h4 class="mb-4" style="color: var(--primary-accent);"><i class="fas fa-file-invoice-dollar me-2"></i> Invoice Configuration</h4>
                <form id="invoice-settings-form">
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="p-3 border rounded">
                                <h6 style="color: var(--secondary-accent);"><i class="fas fa-building me-2"></i> Invoice Company Details</h6>
                                <div class="mb-3">
                                    <label for="invoice-company-name" class="form-label">Company Name (Invoice)</label>
                                    <input type="text" class="form-control" id="invoice-company-name">
                                </div>
                                <div class="mb-3">
                                    <label for="invoice-company-slogan" class="form-label">Slogan (Invoice)</label>
                                    <input type="text" class="form-control" id="invoice-company-slogan">
                                </div>
                                <div class="mb-3">
                                    <label for="invoice-company-address" class="form-label">Adresse</label>
                                    <textarea class="form-control" id="invoice-company-address" rows="2"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="invoice-company-contact" class="form-label">Contact (Phone, Email)</label>
                                    <input type="text" class="form-control" id="invoice-company-contact">
                                </div>
                                <div class="mb-3">
                                    <label for="invoice-company-extra" class="form-label">Extra Info (NUI, etc.)</label>
                                    <input type="text" class="form-control" id="invoice-company-extra">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="p-3 border rounded">
                                <h6 style="color: var(--secondary-accent);"><i class="fas fa-file-alt me-2"></i> Invoice Customization</h6>
                                <div class="mb-3">
                                    <label for="invoice-logo" class="form-label">Logo de la Facture</label>
                                    <input class="form-control" type="file" id="invoice-logo" accept="image/*" onchange="previewImage('invoice-logo', 'invoice-logo-preview')">
                                </div>
                                <div class="text-center mb-3">
                                     <img id="invoice-logo-preview" src="#" alt="Aperçu du Logo de Facture" class="product-image-preview-sm" style="height: 50px; width: 50px; display: none;">
                                </div>
                                <div class="mb-3">
                                    <label for="invoice-watermark" class="form-label">Watermark Text</label>
                                    <input type="text" class="form-control" id="invoice-watermark">
                                </div>
                                <div class="mb-3">
                                    <label for="invoice-message" class="form-label">Custom Message/Note</label>
                                    <textarea class="form-control" id="invoice-message" rows="2"></textarea>
                                </div>
                                <div class="mb-3 form-check">
                                    <input class="form-check-input" type="checkbox" id="invoice-enable-vat">
                                    <label class="form-check-label" for="invoice-enable-vat">
                                        Enable VAT Calculation
                                    </label>
                                </div>
                                <div class="mb-3" id="vat-rate-container" style="display: none;">
                                    <label for="invoice-vat-rate" class="form-label">Taux de TVA (%)</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="invoice-vat-rate" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-glass-secondary w-100 mt-3">Enregistrer les Paramètres de Facture</button>
                </form>
            </div>
        </div>
    </main>
</div>
<!-- Modals -->
<!-- Modal Nouvelle Vente -->
<div class="modal fade" id="newSaleModal" tabindex="-1" aria-labelledby="newSaleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content glass-modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newSaleModalLabel"><i class="fas fa-chart-line me-2"></i> Record a New Sale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="new-sale-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sale-client-name" class="form-label" style="color: var(--primary-accent);">Client Name *</label>
                            <input type="text" class="form-control" id="sale-client-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sale-payment-type" class="form-label">Payment Type</label>
                            <select class="form-select" id="sale-payment-type" onchange="toggleDebtFields()">
                                <option value="Espèces">Espèces</option>
                                <option value="Crédit">On Credit (Debt)</option>
                            </select>
                        </div>
                    </div>
                    <div id="debt-fields" style="display: none;">
                        <hr>
                        <h6 class="text-warning mb-3"><i class="fas fa-exclamation-triangle me-2"></i> Debt Management</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="debt-initial-payment" class="form-label">Initial Payment Amount</label>
                                <input type="number" step="0.01" min="0" class="form-control" id="debt-initial-payment" value="0" oninput="calculateDebtRemaining()" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="debt-remaining" class="form-label">Remaining (Debt)</label>
                                <input type="text" class="form-control text-danger fw-bold" id="debt-remaining" value="0 FCFA" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="debt-due-date" class="form-label">Debt Due Date</label>
                            <input type="date" class="form-control" id="debt-due-date" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5">
                            <label for="sale-product-id" class="form-label">Product Sold</label>
                            <select class="form-select" id="sale-product-id" onchange="updateSaleFormDetails()" required>
                                <option value="" disabled selected>Choose a product</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="sale-qty" class="form-label">Quantité</label>
                            <input type="number" min="1" class="form-control" id="sale-qty" value="1" required>
                        </div>
                        <div class="col-md-3">
                            <label for="sale-price" class="form-label">Unit Price (modifiable)</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="sale-price" required>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-glass w-100" onclick="addItemToCart()">Add to Cart</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="sale-product-expense" class="form-label text-danger">Additional Product Expense (Ex: Transport)</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="sale-product-expense" value="0">
                    </div>
                    <!-- Panier -->
                    <div class="mb-4">
                        <h5>Shopping Cart</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Spécifications</th>
                                        <th>Prix</th>
                                        <th>Qté</th>
                                        <th>Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="sale-cart-body">
                                    <!-- Items du panier seront ajoutés ici -->
                                </tbody>
                            </table>
                        </div>
                        <div class="text-end">
                            <strong>Total Cart: <span id="sale-cart-total">0 FCFA</span></strong>
                        </div>
                    </div>
                    <!-- Option : Générer une facture -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="generate-invoice-checkbox" checked>
                        <label class="form-check-label" for="generate-invoice-checkbox">
                            Generate Invoice for this sale
                        </label>
                    </div>
                    <button type="submit" class="btn btn-glass w-100 btn-lg mt-3">Validate Sale</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal Nouveau Client -->
<div class="modal fade" id="newClientModal" tabindex="-1" aria-labelledby="newClientModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content glass-modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newClientModalLabel"><i class="fas fa-user-plus me-2"></i> New Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="new-client-form">
                    <div class="mb-3">
                        <label for="client-name" class="form-label">Full Name *</label>
                        <input type="text" class="form-control" id="client-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="client-phone" class="form-label">Téléphone</label>
                        <input type="text" class="form-control" id="client-phone">
                    </div>
                    <div class="mb-3">
                        <label for="client-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="client-email">
                    </div>
                    <div class="mb-3">
                        <label for="client-address" class="form-label">Adresse</label>
                        <textarea class="form-control" id="client-address" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-glass w-100">Save Client</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal Mot de passe Historique des tâches -->
<div class="modal fade" id="taskHistoryPasswordModal" tabindex="-1" aria-labelledby="taskHistoryPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content glass-modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskHistoryPasswordModalLabel"><i class="fas fa-lock me-2"></i> Access Task History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="task-history-password-form">
                    <div class="mb-3">
                        <label for="task-history-password" class="form-label">Mot de passe</label>
                        <input type="password" class="form-control" id="task-history-password" required>
                    </div>
                    <button type="submit" class="btn btn-glass w-100">Unlock</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Conteneur invisible pour la facture PDF -->
<div id="invoice-container-template" class="invoice-container">
    <div class="invoice">
        <div class="watermark-logo">FILIGRANE</div>
        <div class="invoice-body">
            <div class="invoice-header">
                <img id="invoice-logo-preview" src="#" alt="Logo" style="max-height: 60px; display: none; margin-bottom: 10px;">
                <h2 id="invoice-company-name">COMPANY NAME</h2>
                <p class="description" id="invoice-company-slogan">SLOGAN</p>
                <p id="invoice-company-address">ADDRESS</p>
                <p id="invoice-company-contact">CONTACT</p>
                <p id="invoice-company-extra">INFOS SUPPLÉMENTAIRES</p>
            </div>
            <div>
                <dl class="invoice-info">
                    <div><dt>Facture N°</dt><dd id="invoice-number">INV-000000</dd></div>
                    <div><dt>Date & Heure</dt><dd id="invoice-date-time">01/01/2025 00:00</dd></div>
                    <div><dt>Client</dt><dd class="client-name" id="invoice-client-name">Nom du client</dd></div>
                    <div><dt>Téléphone du client</dt><dd class="client-phone" id="invoice-client-phone">Téléphone du client</dd></div>
                    <div><dt>Email du client</dt><dd class="client-email" id="invoice-client-email">Email du client</dd></div>
                </dl>
                <table class="articles-table">
                    <thead>
                        <tr>
                            <th>Product/Service</th>
                            <th>Spécifications</th>
                            <th>Prix Unitaire</th>
                            <th>Qté</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody class="invoice-items">
                        <!-- Items will be inserted here by JS -->
                    </tbody>
                </table>
                <div class="total-row"><span>SUBTOTAL (HT)</span><span id="invoice-subtotal">0 FCFA</span></div>
                <div class="item-row vat-row" style="display: none;"><span>VAT (X%)</span><span id="invoice-vat-amount">0 FCFA</span></div>
                <div class="total-row" style="margin-top:10px; border-top:2px solid #333; font-size:1.1em;">
                    <span>TOTAL NET À PAYER</span>
                    <span id="invoice-total-amount">**0 FCFA**</span>
                </div>
                <div class="item-row"><span>Amount in Letters:</span><span id="invoice-amount-words">Zero Francs CFA</span></div>
                <!-- Section pour les avances et le solde -->
                <div class="item-row advance-section" style="display: none;"><span>Advance Paid:</span><span id="invoice-advance-paid">0 FCFA</span></div>
                <div class="item-row payment-section" style="display: none;"><span>Current Payment:</span><span id="invoice-current-payment">0 FCFA</span></div>
                <div class="item-row balance-section" style="display: none;"><span>New Remaining Balance:</span><span id="invoice-new-balance">0 FCFA</span></div>
                <div class="item-row due-date-section" style="display: none;"><span>Due Date:</span><span id="invoice-due-date">01/01/2025</span></div>
                <div class="important-note">
                    <span id="invoice-message">Message personnalisé ici.</span>
                </div>
                <div class="signature-area">
                    <div class="signature-block">Customer Signature</div>
                    <div class="signature-block">Seller Signature</div>
                </div>
            </div>
            <div class="invoice-footer">
                <p id="invoice-company-extra-footer">INFOS SUPPLÉMENTAIRES</p>
                <div class="barcode" id="invoice-barcode">*INV-000000*</div>
            </div>
        </div>
    </div>
    <div class="invoice-button-container">
        <button onclick="window.print()" class="invoice-action-button invoice-download-button">Download PDF 📥</button>
        <button onclick="window.print()" class="invoice-action-button invoice-print-button">Print 🖨️</button>
        <div id="invoice-share-button-container" style="width: 33%; flex-shrink: 0;">
            <button id="invoice-share-toggle-button" class="invoice-action-button invoice-share-button">Share / Send 🚀</button>
            <div id="invoice-share-menu" class="invoice-share-menu"></div>
        </div>
    </div>
</div>
<script>
    // =================================================================
    // CONFIGURATION ET INITIALISATION GLOBALE
    // =================================================================
    let data;
    let charts = {};
    let currentLanguage = 'en';
    let currentUser = null;
    let currentSaleCart = []; // Panier pour la vente en cours
    let isTaskHistoryUnlocked = false; // Pour le verrouillage de l'historique
    // Système de sauvegarde en ligne avec VOTRE clé API
    const API_BASE_URL = 'https://api.jsonbin.io/v3/b';
    const API_KEY = '$2a$10$/3toKmlvDTBs4C2.FxxckOFAMtYvq2u1hZwENdBPmzplr5GoYJwqe'; // VOTRE CLÉ API
    // Comptes utilisateurs prédéfinis - REMPLACEZ LES IDs PAR VOS VRAIS IDs DE BINS
    const USER_ACCOUNTS = {
        'manager': { password: 'manager123', binId: '68e271cb43b1c97be95b1fc9' },
        'vendeur1': { password: 'vendeur123', binId: '68e17297ae596e708f0623ae' },
        'vendeur2': { password: 'vendeur123', binId: '68e172bcae596e708f0623cf' },
        'admin': { password: 'admin123', binId: '68e1721cae596e708f06235d' },
        'comptable': { password: 'comptable123', binId: '68e172e743b1c97be95a6c50' },
        'stock': { password: 'stock123', binId: '68e17302ae596e708f0623fa' },
        'consultant': { password: 'consultant123', binId: '68e17323ae596e708f062409' }
    };
    const DEFAULT_SETTINGS = {
        username: 'admin',
        language: 'en',
        currencySymbol: 'FCFA',
        companyName: 'AB-APP',
        companySlogan: 'Intelligent Management',
        logo: null,
        lowStockThreshold: 5,
        lastCategoryId: 0,
        lastProductId: 0,
        lastSaleId: 0,
        lastExpenseId: 0,
        lastDebtId: 0,
        lastClientId: 0,
        notifications: [],
        // Nouveaux paramètres pour la facture
        invoiceCompanyName: 'Votre Entreprise',
        invoiceCompanySlogan: 'Votre Slogan',
        invoiceCompanyAddress: 'Votre Adresse',
        invoiceCompanyContact: 'Tél : 000 000 000 | Email : contact@entreprise.com',
        invoiceCompanyExtra: 'NUI : 0000000000000',
        invoiceLogo: null,
        invoiceWatermark: 'VOTRE ENTREPRISE',
        invoiceMessage: 'Merci pour votre achat !',
        invoiceEnableVat: false,
        invoiceVatRate: 0,
        invoices: [], // Stockage des factures
        taskHistory: [] // Stockage de l'historique des tâches
    };
    // =================================================================
    // AUTHENTIFICATION ET SAUVEGARDE EN LIGNE
    // =================================================================
    // Vérifier l'authentification au chargement
    async function checkAuth() {
        const savedUser = localStorage.getItem('alphaProUser');
        if (savedUser) {
            currentUser = savedUser;
            await loadUserData();
        } else {
            showLoginPage();
        }
    }
    // Connexion sécurisée
    async function login(e) {
        e.preventDefault();
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        const loginBtn = document.getElementById('login-btn');
        const alertDiv = document.getElementById('login-alert');
        // Réinitialiser l'alerte
        alertDiv.classList.add('d-none');
        // Désactiver le bouton pendant la requête
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Connecting...';
        // Vérifier les identifiants
        if (USER_ACCOUNTS[username] && USER_ACCOUNTS[username].password === password) {
            currentUser = username;
            localStorage.setItem('alphaProUser', username);
            // Charger les données de l'utilisateur
            await loadUserData();
            // Afficher le message de bienvenue
            document.getElementById('welcome-message').style.display = 'flex';
            document.getElementById('welcome-title').textContent = `Welcome, ${username} !`;
        } else {
            showAlert(alertDiv, 'Nom dutilisateur ou mot de passe incorrect');
        }
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fas fa-lock me-2"></i> Sign In';
    }
    // Charger les données de l'utilisateur depuis le serveur
    async function loadUserData() {
        try {
            const userBinId = USER_ACCOUNTS[currentUser].binId;
            const response = await fetch(`${API_BASE_URL}/${userBinId}/latest`, {
                headers: {
                    'X-Master-Key': API_KEY
                }
            });
            if (response.ok) {
                const result = await response.json();
                data = { ...loadDefaultData(), ...result.record };
                showApp();
            } else {
                // Si pas de données sur le serveur, utiliser les données par défaut
                data = loadDefaultData();
                showApp();
            }
        } catch (error) {
            console.error('Error loading ', error);
            // En cas d'erreur, utiliser les données par défaut
            data = loadDefaultData();
            showApp();
        }
    }
    // Sauvegarder les données de l'utilisateur sur le serveur
    async function saveUserData() {
        try {
            const userBinId = USER_ACCOUNTS[currentUser].binId;
            const response = await fetch(`${API_BASE_URL}/${userBinId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': API_KEY
                },
                body: JSON.stringify(data)
            });
            if (response.ok) {
                console.log('Data saved successfully');
            }
        } catch (error) {
            console.error('Error saving ', error);
        }
    }
    // Charger les données par défaut
    function loadDefaultData() {
        return {
            products: [],
            categories: [],
            sales: [],
            expenses: [],
            debts: [],
            clients: [],
            settings: DEFAULT_SETTINGS
        };
    }
    // Persister les données (sauvegarde en ligne)
    function persistData() {
        saveUserData();
        updateNotificationCount();
        if (document.getElementById('dashboard').style.display !== 'none') {
            updateDashboard();
        }
        if (document.getElementById('analytics').style.display !== 'none') {
            updateAnalytics();
        }
    }
    // Afficher une alerte
    function showAlert(alertElement, message, type = 'danger') {
        alertElement.textContent = message;
        alertElement.className = `alert alert-${type}`;
        alertElement.classList.remove('d-none');
    }
    // Afficher la page de connexion
    function showLoginPage() {
        document.getElementById('login-page').style.display = 'block';
        document.getElementById('app-container').style.display = 'none';
    }
    // Afficher l'application
    function showApp() {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        updateHeaderInfo();
        showPage('dashboard');
        // Afficher le nom d'utilisateur
        if (currentUser) {
            document.getElementById('current-user-display').textContent = currentUser;
        }
    }
    // Déconnexion
    function logout() {
        if (confirm("Are you sure you want to log out?")) {
            currentUser = null;
            localStorage.removeItem('alphaProUser');
            showLoginPage();
        }
    }
    // =================================================================
    // FONCTIONS DE BASE
    // =================================================================
    function hideWelcomeMessage() {
        document.getElementById('welcome-message').style.display = 'none';
    }
    // =================================================================
    // NOUVELLE FONCTION POUR LE BOUTON DE VENTE RAPIDE
    // =================================================================
    function openNewSaleModal() {
        // S'assurer que le select des produits est mis à jour
        populateSaleProductSelect();
        // Réinitialiser le panier
        currentSaleCart = [];
        renderSaleCart();
        // Réinitialiser la case à cocher de génération de facture
        document.getElementById('generate-invoice-checkbox').checked = true; // Coché par défaut
        // Réinitialiser les champs de vente
        document.getElementById('sale-client-name').value = '';
        document.getElementById('sale-payment-type').value = 'Espèces';
        document.getElementById('sale-qty').value = '1';
        document.getElementById('sale-price').value = '';
        document.getElementById('sale-product-expense').value = '0';
        toggleDebtFields(); // Cacher les champs de dette
        // Ouvrir le modal
        const modal = new bootstrap.Modal(document.getElementById('newSaleModal'));
        modal.show();
    }
    // =================================================================
    // OUTILS UTILITAIRES
    // =================================================================
    function fileToBase64(file) {
        if (!file) return Promise.resolve(null);
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
    function formatCurrency(amount) {
        if (isNaN(amount)) amount = 0;
        const symbol = data.settings.currencySymbol || 'FCFA';
        return `${Math.round(amount).toLocaleString('fr-FR')} ${symbol}`;
    }
    function getProductById(id) {
        return data.products.find(p => p.id === id);
    }
    function getCategoryName(id) {
        const category = data.categories.find(c => c.id === id);
        return category ? category.name : 'Uncategorized';
    }
    const translations = {
        fr: {
  "Product Management": "Gestion des Produits",
  "Exporter les Produits": "Exporter les Produits",
  "Stock Entry / New Product": "Entrée de Stock / Nouveau Produit",
  "Product Name": "Nom du Produit",
  "Catégorie": "Catégorie",
  "Choose a category": "Choisir une catégorie",
  "Characteristics (Max 30 chars)": "Caractéristiques (Max 30 chars)",
  "Prix d'Achat": "Prix d'Achat",
  "Prix de Vente": "Prix de Vente",
  "Quantity In": "Quantité Entrante",
  "Alert Qty (Low Stock)": "Qté d'Alerte (Stock Bas)",
  "Product Image (Optional)": "Image du Produit (Optionnel)",
  "Add to Stock": "Ajouter au Stock",
  "Categories": "Catégories",
  "Category name": "Nom de la catégorie",
  "Add/Update": "Ajouter/Modifier",
  "Current Inventory": "Inventaire Actuel",
  "Search a product...": "Rechercher un produit...",
  "Image": "Image",
  "Nom": "Nom",
  "Spécifications": "Spécifications",
  "Qty": "Qté",
  "Action": "Action",

  "Client Management": "Gestion des Clients",
  "New Client": "Nouveau Client",
  "Client List": "Liste des Clients",
  "Search a client...": "Rechercher un client...",
  "Phone": "Téléphone",
  "Active Debts": "Dettes Actives",
  "Total Purchase": "Achat Total",

  "Sales Management": "Gestion des Ventes",
  "New Sale": "Nouvelle Vente",
  "Export Sales": "Exporter les Ventes",
  "Filters": "Filtres",
  "Search & Filter": "Recherche & Filtre",
  "Filter by client name...": "Filtrer par nom de client...",
  "Filter by product name...": "Filtrer par nom de produit...",
  "Tous les Statuts": "Tous les Statuts",

  "Sales History": "Historique des Ventes",
  "Date": "Date",
  "Client": "Client",
  "Produits": "Produits",
  "Total Price": "Prix Total",
  "Marge Brute": "Marge Brute",
  "Marge Nette": "Marge Nette",
  "Statut": "Statut",

  "Invoice Management": "Gestion des Factures",
  "Export Invoices": "Exporter les Factures",
  "Generated Invoices": "Factures Générées",
  "N° Facture": "N° Facture",
  "Total": "Total",

  "Historique des Tâches": "Historique des Tâches",
  "Export History": "Exporter l'Historique",
  "Action Log": "Journal d'Actions",
  "Filter by user...": "Filtrer par utilisateur...",
  "All Actions": "Toutes les Actions",
  "Date & Time": "Date & Heure",
  "User": "Utilisateur",
  "Details": "Détails",

  "Bénéfices et Dépenses Mensuels": "Bénéfices et Dépenses Mensuels",
  "Répartition des Dépenses": "Répartition des Dépenses",
  "Stock par Catégorie": "Stock par Catégorie",

  "Paramètres": "Paramètres",
  "General Settings": "Paramètres Généraux",
  "Nom de l'Entreprise": "Nom de l'Entreprise",
  "Slogan de l'Entreprise": "Slogan de l'Entreprise",
  "Currency Symbol": "Symbole Monétaire",
  "Low Stock Threshold": "Seuil de Stock Bas",
  "Language": "Langue",
  "Save General Settings": "Enregistrer les Paramètres Généraux",

  "Invoice Settings": "Paramètres de Facture",
  "Logo de Facture (URL)": "Logo de Facture (URL)",
  "Invoice Footer Message": "Message de Pied de Page",
  "Activer la TVA": "Activer la TVA",
  "Taux de TVA (%)": "Taux de TVA (%)",
  "Save Invoice Settings": "Enregistrer les Paramètres de Facture",

  "Bénéfice Net": "Bénéfice Net",
  "Chiffre d'Affaires": "Chiffre d'Affaires",
  "Critical Stock": "Stock Critique",
  "Total des Dettes": "Dettes Totales",
  "Quantité Vendue": "Quantité Vendue",
  "Expenses (Total)": "Dépenses (Total)",
  "Current Client Debts": "Dettes Clients Actuelles",

  "Welcome, AB-APP User!": "Bienvenue, Utilisateur AB-APP !",
  "Your intelligent management platform is ready.": "Votre plateforme de gestion intelligente est prête.",
  "Get Started": "Commencer",

  "Secure Login": "Connexion Sécurisée",
  "Username": "Nom d'utilisateur",
  "Password": "Mot de passe",
  "Sign In": "Se Connecter",
  "Secured session • Data saved online": "Session sécurisée • Données sauvegardées en ligne",

  "Tableau de Bord": "Tableau de Bord",
  "Clients": "Clients",
  "Ventes": "Ventes",
  "Factures": "Factures",
  "Analyses": "Analyses",
  "History": "Historique",

  "Notifications": "Notifications",
  "Mark all as read": "Tout marquer comme lu",
  "Delete all": "Tout supprimer",
  "Aucune notification": "Aucune notification",
  "Déconnexion": "Déconnexion",

  "English": "Anglais",
  "Français": "Français",
  "Account": "Compte",

  "Période": "Période",
  "transactions": "transactions",
  "Vérifier l'Inventaire": "Vérifier l'Inventaire",
  "unités": "unités",
  "Avant dépenses": "Avant dépenses",
  "Après dépenses": "Après dépenses",

  "Ajouter Produit": "Ajouter Produit",
  "Ajouter Vente": "Ajouter Vente",
  "Ajouter Client": "Ajouter Client",
  "Supprimer Vente": "Supprimer Vente",
  "Générer Facture": "Générer Facture",
  "Enregistrer Paiement": "Enregistrer Paiement",

  "Espèces": "Espèces",
  "Crédit": "Crédit",

  "Facture générée pour la vente à": "Facture générée pour la vente à",
  "Une facture existe déjà pour cette vente.": "Une facture existe déjà pour cette vente.",

  "Paramètres enregistrés avec succès !": "Paramètres enregistrés avec succès !",
  "Paramètres généraux enregistrés avec succès !": "Paramètres généraux enregistrés avec succès !",
  "Paramètres de facture enregistrés avec succès !": "Paramètres de facture enregistrés avec succès !",

  "Mot de passe incorrect pour l'historique.": "Mot de passe incorrect pour l'historique.",
  "Le nom est requis.": "Le nom est requis.",
  "Le nom du client est requis.": "Le nom du client est requis.",
  "Veuillez sélectionner un produit, une quantité et un prix.": "Veuillez sélectionner un produit, une quantité et un prix.",
  "Stock insuffisant. Restant :": "Stock insuffisant. Restant :",

  "Vente supprimée avec succès. La facture associée reste.": "Vente supprimée avec succès. La facture associée reste.",
  "Le paiement ne peut pas dépasser le montant restant.": "Le paiement ne peut pas dépasser le montant restant.",

  "Êtes-vous sûr ?": "Êtes-vous sûr ?",
  "Supprimer ce produit ?": "Supprimer ce produit ?",
  "Supprimer cette catégorie ?": "Supprimer cette catégorie ?",
  "Supprimer ce client ?": "Supprimer ce client ?",
  "Supprimer cette vente ?": "Supprimer cette vente ?",
  "Supprimer cette dépense ?": "Supprimer cette dépense ?",

  "Facture": "Facture",
  "Facturer à": "Facturer à",
  "Description": "Description",
  "Prix Unitaire": "Prix Unitaire",
  "Montant": "Montant",
  "Sous-total": "Sous-total",
  "TVA": "TVA",
  "Payé": "Payé",
  "Solde dû": "Solde dû",
  "Date d'échéance": "Date d'échéance",
  "Merci pour votre confiance !": "Merci pour votre confiance !",
  "Page": "Page",
  "sur": "sur"
        },
        en: {}
    };

    function translateText(text) {
        if (currentLanguage === 'en') return text;
        return translations.fr[text] || text;
    }

    function changeLanguage(lang) {
        try {
            currentLanguage = lang;
            if (data && data.settings) data.settings.language = lang;
            persistData();
            
            const productSearch = document.getElementById("product-search-input");
            const clientSearch = document.getElementById("client-search-input");
            
            if (lang === "fr") {
                if (productSearch) productSearch.placeholder = "Rechercher un produit...";
                if (clientSearch) clientSearch.placeholder = "Rechercher un client...";
            } else {
                if (productSearch) productSearch.placeholder = "Rechercher un produit...";
                if (clientSearch) clientSearch.placeholder = "Rechercher un client...";
            }
            
            
            // Traduction des éléments statiques marqués
            document.querySelectorAll("[data-i18n]").forEach(el => {
                const key = el.getAttribute("data-i18n");
                el.textContent = translateText(key);
            });
            // Exécution sécurisée des mises à jour d'interface
            const updates = [
                updateDashboard, renderCategories, renderProductInflow, 
                renderSales, renderDebts, renderExpenses, renderClients, 
                renderInvoices, renderTaskHistory, updateNotificationCount
            ];
            
            updates.forEach(fn => {
                try { if (typeof fn === "function") fn(); } catch (e) { console.warn("Update failed for " + fn.name, e); }
            });
        } catch (error) {
            console.error("Error in changeLanguage:", error);
        }
    }
    function showPage(pageId) {
        // Vérifier l'accès à l'historique des tâches
        if (pageId === 'task-history' && !isTaskHistoryUnlocked) {
            const modal = new bootstrap.Modal(document.getElementById('taskHistoryPasswordModal'));
            modal.show();
            return;
        }

        document.querySelectorAll('.page-content').forEach(page => {
            page.style.display = 'none';
        });
        document.getElementById(pageId).style.display = 'block';
        document.querySelectorAll('.fixed-bottom-nav .nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`.fixed-bottom-nav a[onclick="showPage('${pageId}')"]`).classList.add('active');
        if (pageId === 'dashboard') updateDashboard();
        if (pageId === 'categories') { renderCategories(); renderProductInflow(); populateCategorySelects(['product-category', 'filter-category']); populateFilterSelects(); }
        if (pageId === 'clients') renderClients();
        if (pageId === 'sales-management') { renderSales(); populateSaleProductSelect(); }
        if (pageId === 'invoices-management') renderInvoices();
        if (pageId === 'analytics') updateAnalytics();
        if (pageId === 'debts-management') renderDebts();
        if (pageId === 'expenses-management') renderExpenses();
        if (pageId === 'task-history') renderTaskHistory();
        if (pageId === 'settings') loadSettingsPage();
    }
    // =================================================================
    // LOGIQUE D'HISTORIQUE DES TÂCHES
    // =================================================================
    function logTask(action, details) {
        const now = new Date();
        const logEntry = {
            id: Date.now(), // Simple ID basé sur le timestamp
            date: now.toISOString().slice(0, 10),
            time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            user: currentUser,
            action: action,
            details: details
        };
        data.settings.taskHistory.push(logEntry);
        persistData(); // Sauvegarde à chaque action
    }

    document.getElementById('task-history-password-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const password = document.getElementById('task-history-password').value;
        if (password === 'loghistory1') {
            isTaskHistoryUnlocked = true;
            const modal = bootstrap.Modal.getInstance(document.getElementById('taskHistoryPasswordModal'));
            modal.hide();
            showPage('task-history');
        } else {
            alert("Mot de passe incorrect pour l'historique.");
        }
    });

    function renderTaskHistory() {
        const tbody = document.getElementById('task-history-table-body');
        if (!tbody) return;

        let logs = [...data.settings.taskHistory].reverse(); // Plus récent en premier

        // Filtres
        const dateStart = document.getElementById('log-date-start').value;
        const dateEnd = document.getElementById('log-date-end').value;
        const userSearch = document.getElementById('log-user-search').value.toLowerCase();
        const actionType = document.getElementById('log-action-type').value;

        logs = logs.filter(log => {
            const logDate = new Date(log.date);
            const start = dateStart ? new Date(dateStart) : new Date(0);
            const end = dateEnd ? new Date(dateEnd) : new Date();
            const matchesDate = logDate >= start && logDate <= end;
            const matchesUser = log.user.toLowerCase().includes(userSearch);
            const matchesAction = actionType === 'all' || log.action === actionType;
            return matchesDate && matchesUser && matchesAction;
        });

        tbody.innerHTML = logs.map(log => `
            <tr>
                <td>${log.date} ${log.time}</td>
                <td>${log.user}</td>
                <td>${log.action}</td>
                <td>${log.details}</td>
            </tr>
        `).join('');
    }

    function exportTaskHistoryToCSV() {
        let csvContent = "Date,Time,User,Action,Details\n";
        data.settings.taskHistory.forEach(log => {
            csvContent += `"${log.date}","${log.time}","${log.user}","${log.action}","${log.details}"\n`;
        });
        downloadCSV(csvContent, 'alpha_pro_task_history.csv');
    }

    // =================================================================
    // GESTION DES NOTIFICATIONS
    // =================================================================
    function updateNotificationCount() {
        const criticalProducts = data.products.filter(p => p.qty <= p.alertQty && p.alertQty > 0);
        const today = new Date();
        const oneWeek = 7 * 24 * 60 * 60 * 1000;
        const expiringDebts = data.debts.filter(d => 
            d.remaining > 0 && 
            (new Date(d.dueDate) - today) <= oneWeek && 
            (new Date(d.dueDate) >= today)
        );
        const totalNotifications = criticalProducts.length + expiringDebts.length;
        const notificationCounter = document.getElementById('notification-counter');
        const notificationList = document.getElementById('notification-list');
        notificationCounter.textContent = totalNotifications;
        if (totalNotifications > 0) {
            notificationCounter.style.display = 'block';
            let html = '';
            // Notifications de stock critique
            html += criticalProducts.map(p => `
                <div class="alert alert-warning p-2 mb-2 d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-exclamation-circle me-2"></i> Critical stock for <strong>${p.name}</strong> (${p.qty} remaining)
                    </div>
                    <button class="btn btn-sm btn-outline-info" onclick="editProduct('${p.name}'); bootstrap.Offcanvas.getInstance(document.getElementById('notificationCanvas')).hide();">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            `).join('');
            // Notifications de dettes expirant
            html += expiringDebts.map(d => `
                <div class="alert alert-danger p-2 mb-2 d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-clock me-2"></i> Debt from <strong>${d.clientName}</strong> expires on ${d.dueDate} (${formatCurrency(d.remaining)}).
                    </div>
                    <button class="btn btn-sm btn-outline-warning" onclick="recordDebtPayment(${d.id}); bootstrap.Offcanvas.getInstance(document.getElementById('notificationCanvas')).hide();">
                        <i class="fas fa-hand-holding-usd"></i>
                    </button>
                </div>
            `).join('');
            notificationList.innerHTML = html;
        } else {
            notificationCounter.style.display = 'none';
            notificationList.innerHTML = `<p class="text-muted text-center">Aucune notification</p>`;
        }
    }
    function markAllNotificationsRead() {
        document.getElementById('notification-counter').style.display = 'none';
        document.getElementById('notification-counter').textContent = '0';
        document.getElementById('notification-list').innerHTML = `<p class="text-muted text-center">Aucune notification</p>`;
    }
    function clearAllNotifications() {
        document.getElementById('notification-counter').style.display = 'none';
        document.getElementById('notification-counter').textContent = '0';
        document.getElementById('notification-list').innerHTML = `<p class="text-muted text-center">Aucune notification</p>`;
    }
    // =================================================================
    // GESTION DES CATÉGORIES ET PRODUITS
    // =================================================================
    document.getElementById('category-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('category-id').value;
        const name = document.getElementById('category-name').value.trim();
        if (!name) return alert("Le nom est requis.");
        if (id) {
            const category = data.categories.find(c => c.id == id);
            if (category) category.name = name;
        } else {
            data.settings.lastCategoryId++;
            data.categories.push({ id: data.settings.lastCategoryId, name: name });
        }
        logTask('add_category', `Added/Updated category: ${name}`);
        persistData();
        renderCategories(); 
        populateCategorySelects(['product-category', 'filter-category']);
        populateFilterSelects();
        this.reset();
    });
    function populateCategorySelects(selectIds) {
        selectIds.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (!select) return;
            const selectedValue = select.value;
            select.innerHTML = select.id === 'filter-category' ? 
                `<option value="all">Tout</option>` :
                `<option value="" disabled selected>Choisir une catégorie</option>`;
            data.categories.forEach(cat => {
                select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
            select.value = selectedValue;
        });
    }
    function populateFilterSelects() {
        // Pour le filtre de catégorie sur la page Produits
        const categoryFilter = document.getElementById('product-category-filter');
        if (categoryFilter) {
            categoryFilter.innerHTML = `<option value="all">All Categories</option>`;
            data.categories.forEach(cat => {
                categoryFilter.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
        }
    }
    function renderCategories() {
        const tbody = document.getElementById('categories-table-body');
        if (!tbody) return; 
        tbody.innerHTML = data.categories.map(cat => `
            <tr>
                <td>${cat.name}</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-info me-1" onclick="editCategory(${cat.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${cat.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    function editCategory(id) {
        const category = data.categories.find(c => c.id === id);
        if (category) {
            document.getElementById('category-id').value = category.id;
            document.getElementById('category-name').value = category.name;
        }
    }
    function deleteCategory(id) {
        if (confirm("Delete this category? Associated products will remain but the category will be 'Uncategorized'.")) {
            data.categories = data.categories.filter(c => c.id !== id);
            logTask('delete_category', `Deleted category with ID: ${id}`);
            persistData();
            renderCategories();
            populateCategorySelects(['product-category', 'filter-category']);
            populateFilterSelects();
        }
    }
    // GESTION DES PRODUITS / ENTRÉE DE STOCK
    document.getElementById('inflow-product-name-input').addEventListener('input', function() {
        const productName = this.value.trim();
        const product = data.products.find(p => p.name.toLowerCase() === productName.toLowerCase());
        const imgPreview = document.getElementById('product-image-preview-large');
        const submitBtn = document.getElementById('inflow-submit-btn');
        if (product) {
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-category').value = product.categoryId;
            document.getElementById('product-specs').value = product.specs || '';
            document.getElementById('product-buy-price').value = product.buyPrice;
            document.getElementById('product-sale-price').value = product.salePrice;
            document.getElementById('product-alert-qty').value = product.alertQty;
            submitBtn.innerHTML = `<i class="fas fa-edit me-2"></i> Edit and Add Stock`;
            if (product.image) {
                imgPreview.src = product.image;
                imgPreview.style.display = 'block';
            } else {
                imgPreview.style.display = 'none';
            }
        } else {
            document.getElementById('product-id').value = '';
            document.getElementById('product-specs').value = '';
            document.getElementById('product-buy-price').value = '';
            document.getElementById('product-sale-price').value = '';
            document.getElementById('product-alert-qty').value = data.settings.lowStockThreshold;
            submitBtn.innerHTML = `<i class="fas fa-plus me-2"></i> Add to Stock`;
            imgPreview.style.display = 'none';
        }
        document.getElementById('product-inflow-qty').value = '1'; 
    });
    
    async function previewImage(fileInputId, previewImgId) {
        const fileInput = document.getElementById(fileInputId);
        const previewImg = document.getElementById(previewImgId);
        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                // Sauvegarde automatique selon le type de logo
                if (fileInputId === 'invoice-logo') {
                    data.settings.invoiceLogo = e.target.result;
                    persistData();
                } else if (fileInputId === 'setting-logo') {
                    data.settings.logo = e.target.result;
                    persistData();
                }
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            previewImg.src = "#";
            previewImg.style.display = 'none';
        }
    }
    document.getElementById('product-inflow-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const productId = document.getElementById('product-id').value;
        const name = document.getElementById('inflow-product-name-input').value.trim();
        const categoryId = document.getElementById('product-category').value;
        const specs = document.getElementById('product-specs').value.trim().substring(0, 30); // Limiter à 30 caractères
        const buyPrice = parseFloat(document.getElementById('product-buy-price').value);
        const salePrice = parseFloat(document.getElementById('product-sale-price').value);
        const inflowQty = parseInt(document.getElementById('product-inflow-qty').value);
        const alertQty = parseInt(document.getElementById('product-alert-qty').value) || data.settings.lowStockThreshold;
        const imageFile = document.getElementById('product-image').files[0];
        if (!name || !categoryId || isNaN(buyPrice) || isNaN(salePrice) || isNaN(inflowQty) || inflowQty <= 0) {
            return alert("Please fill all required fields correctly.");
        }
        const imageBase64 = await fileToBase64(imageFile); 
        let product = getProductById(productId ? parseInt(productId) : null) || data.products.find(p => p.name.toLowerCase() === name.toLowerCase());
        let isNewProduct = false;
        if (product) {
            const oldQty = product.qty;
            product.name = name;
            product.categoryId = parseInt(categoryId);
            product.specs = specs; // Mettre à jour les specs
            product.buyPrice = buyPrice;
            product.salePrice = salePrice;
            product.qty += inflowQty;
            product.alertQty = alertQty;
            if (imageBase64) product.image = imageBase64;
            logTask('update_product', `Updated product '${name}'. Stock changed from ${oldQty} to ${product.qty}.`);
        } else {
            isNewProduct = true;
            data.settings.lastProductId++;
            product = { 
                id: data.settings.lastProductId, 
                name: name, 
                categoryId: parseInt(categoryId),
                specs: specs, // Enregistrer les specs
                buyPrice: buyPrice,
                salePrice: salePrice,
                qty: inflowQty,
                alertQty: alertQty,
                image: imageBase64 
            };
            data.products.push(product);
            logTask('add_product', `Added new product: ${name}, Qty: ${inflowQty}`);
        }
        persistData();
        renderProductInflow(); 
        populateFilterSelects(); 
        populateSaleProductSelect();
        alert(isNewProduct ? `New product '${name}' added.` : `Stock of '${name}' updated.`);
        this.reset();
        document.getElementById('inflow-product-name-input').value = ''; 
        document.getElementById('product-id').value = ''; 
        document.getElementById('product-image-preview-large').style.display = 'none';
        document.getElementById('inflow-submit-btn').innerHTML = `<i class="fas fa-plus me-2"></i> Add to Stock`;
    });
    function renderProductInflow() {
        const tbody = document.getElementById('product-inflow-table-body');
        if (!tbody) return;
        const searchTerm = document.getElementById('product-search-input')?.value.toLowerCase() || '';
        const categoryFilter = document.getElementById('product-category-filter')?.value;
        let filteredProducts = data.products;
        if (searchTerm) {
            filteredProducts = filteredProducts.filter(p => p.name.toLowerCase().includes(searchTerm));
        }
        if (categoryFilter && categoryFilter !== 'all') {
            filteredProducts = filteredProducts.filter(p => p.categoryId == categoryFilter);
        }
        filteredProducts.sort((a, b) => b.qty - a.qty);
        tbody.innerHTML = filteredProducts.map(p => {
            const isCritical = p.qty <= p.alertQty && p.alertQty > 0;
            const rowClass = isCritical ? 'table-warning' : '';
            return `
                <tr class="${rowClass}">
                    <td>
                        <img src="${p.image || ''}" alt="Image" class="product-image-preview-sm" style="${p.image ? 'display: block;' : 'display: none;'}">
                    </td>
                    <td>${p.name} <br><small class="text-muted">${getCategoryName(p.categoryId)}</small></td>
                    <td>${p.specs || '-'}</td>
                    <td class="${isCritical ? 'text-danger fw-bold' : ''}">${p.qty}</td>
                    <td>${formatCurrency(p.salePrice)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="editProduct('${p.name}')" title="Edit/Add Stock">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.id})" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    function editProduct(name) {
        document.getElementById('inflow-product-name-input').value = name;
        document.getElementById('inflow-product-name-input').dispatchEvent(new Event('input')); 
    }
    function deleteProduct(id) {
        if (confirm("Delete this product permanently?")) {
            const product = getProductById(id);
            if (product) {
                data.products = data.products.filter(p => p.id !== id);
                logTask('delete_product', `Deleted product: ${product.name}`);
                persistData();
                renderProductInflow();
                populateFilterSelects();
                populateSaleProductSelect();
            }
        }
    }
    function populateFilterSelects() {
        const productSelect = document.getElementById('filter-product');
        if (productSelect) {
            const selectedValue = productSelect.value;
            productSelect.innerHTML = `<option value="all">Tout</option>`;
            data.products.forEach(p => {
                productSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            productSelect.value = selectedValue;
        }
    }
    // =================================================================
    // GESTION DES CLIENTS
    // =================================================================
    document.getElementById('new-client-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('client-name').value.trim();
        const phone = document.getElementById('client-phone').value.trim();
        const email = document.getElementById('client-email').value.trim();
        const address = document.getElementById('client-address').value.trim();
        if (!name) return alert("Le nom du client est requis.");
        data.settings.lastClientId++;
        const newClient = {
            id: data.settings.lastClientId,
            name: name,
            phone: phone,
            email: email,
            address: address,
            createdAt: new Date().toISOString().slice(0, 10)
        };
        data.clients.push(newClient);
        logTask('add_client', `Added new client: ${name}`);
        persistData();
        renderClients();
        const modal = bootstrap.Modal.getInstance(document.getElementById('newClientModal'));
        if (modal) modal.hide();
        this.reset();
        alert(`Client '${name}' added successfully.`);
    });
    function renderClients() {
        const tbody = document.getElementById('clients-table-body');
        if (!tbody) return;
        const searchTerm = document.getElementById('client-search-input')?.value.toLowerCase() || '';
        const filteredClients = data.clients.filter(c => c.name.toLowerCase().includes(searchTerm));
        tbody.innerHTML = filteredClients.map(client => {
            // Calculer les dettes actives du client
            const clientDebts = data.debts.filter(d => d.clientName === client.name && d.remaining > 0);
            const totalDebt = clientDebts.reduce((sum, debt) => sum + debt.remaining, 0);
            // Calculer le total des achats du client
            const clientSales = data.sales.filter(s => s.clientName === client.name);
            const totalPurchases = clientSales.reduce((sum, sale) => sum + sale.total, 0);
            return `
                <tr>
                    <td>${client.name}</td>
                    <td>${client.phone || '-'}</td>
                    <td>${client.email || '-'}</td>
                    <td class="${totalDebt > 0 ? 'text-danger fw-bold' : ''}">${formatCurrency(totalDebt)}</td>
                    <td>${formatCurrency(totalPurchases)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="editClient(${client.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteClient(${client.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    function editClient(id) {
        const client = data.clients.find(c => c.id === id);
        if (client) {
            document.getElementById('client-name').value = client.name;
            document.getElementById('client-phone').value = client.phone || '';
            document.getElementById('client-email').value = client.email || '';
            document.getElementById('client-address').value = client.address || '';
            // Ouvrir le modal
            const modal = new bootstrap.Modal(document.getElementById('newClientModal'));
            modal.show();
            // Changer le titre du modal
            document.getElementById('newClientModalLabel').innerHTML = '<i class="fas fa-user-edit me-2"></i> Edit Client';
            // Stocker l'ID du client à modifier
            document.getElementById('new-client-form').dataset.editingId = id;
        }
    }
    function deleteClient(id) {
        if (confirm("Delete this client permanently?")) {
            data.clients = data.clients.filter(c => c.id !== id);
            logTask('delete_client', `Deleted client with ID: ${id}`);
            persistData();
            renderClients();
        }
    }
    // =================================================================
    // GESTION DES VENTES - PANIER
    // =================================================================
    function populateSaleProductSelect() {
        const select = document.getElementById('sale-product-id');
        if (!select) return;
        select.innerHTML = `<option value="" disabled selected>Choose a product</option>`;
        data.products.forEach(p => {
            select.innerHTML += `<option value="${p.id}">${p.name} (${formatCurrency(p.salePrice)})</option>`;
        });
    }

    function updateSaleFormDetails() {
        const productId = parseInt(document.getElementById('sale-product-id').value);
        const product = getProductById(productId);
        if (product) {
            document.getElementById('sale-price').value = product.salePrice;
        } else {
             document.getElementById('sale-price').value = '';
        }
    }

    function addItemToCart() {
        const productId = parseInt(document.getElementById('sale-product-id').value);
        const qty = parseInt(document.getElementById('sale-qty').value) || 0;
        const unitPrice = parseFloat(document.getElementById('sale-price').value) || 0;

        if (!productId || qty <= 0 || unitPrice <= 0) {
            alert("Veuillez sélectionner un produit, une quantité et un prix.");
            return;
        }

        const product = getProductById(productId);
        if (!product) return alert("Product not found.");
        if (qty > product.qty) {
            return alert(`Insufficient stock. Remaining: ${product.qty}`);
        }

        const cartItem = {
            id: product.id,
            name: product.name,
            specs: product.specs || 'N/A',
            unitPrice: unitPrice,
            qty: qty,
            total: qty * unitPrice
        };

        currentSaleCart.push(cartItem);
        renderSaleCart();
        // Réinitialiser les champs
        document.getElementById('sale-qty').value = '1';
        document.getElementById('sale-price').value = product.salePrice;
    }

    function renderSaleCart() {
        const tbody = document.getElementById('sale-cart-body');
        if (!tbody) return;
        tbody.innerHTML = currentSaleCart.map((item, index) => `
            <tr>
                <td>${item.name}</td>
                <td>${item.specs}</td>
                <td>${formatCurrency(item.unitPrice)}</td>
                <td>${item.qty}</td>
                <td>${formatCurrency(item.total)}</td>
                <td><button class="btn btn-sm btn-outline-danger" onclick="removeCartItem(${index})"><i class="fas fa-trash"></i></button></td>
            </tr>
        `).join('');

        const total = currentSaleCart.reduce((sum, item) => sum + item.total, 0);
        document.getElementById('sale-cart-total').textContent = formatCurrency(total);
    }

    function removeCartItem(index) {
        currentSaleCart.splice(index, 1);
        renderSaleCart();
    }

    function toggleDebtFields() {
        const paymentType = document.getElementById('sale-payment-type').value;
        document.getElementById('debt-fields').style.display = paymentType === 'Crédit' ? 'block' : 'none';
        document.getElementById('debt-initial-payment').required = (paymentType === 'Crédit');
        document.getElementById('debt-due-date').required = (paymentType === 'Crédit');
        calculateDebtRemaining();
    }

    function calculateDebtRemaining() {
        const totalCartText = document.getElementById('sale-cart-total').textContent;
        const totalCart = parseFloat(totalCartText.replace(/[^\d,\.]/g, '').replace(',', '.')) || 0;
        const initialPayment = parseFloat(document.getElementById('debt-initial-payment').value) || 0;
        const paymentType = document.getElementById('sale-payment-type').value;
        let remaining = 0;
        if (paymentType === 'Crédit') {
             remaining = totalCart - initialPayment;
        }
        document.getElementById('debt-remaining').value = formatCurrency(remaining > 0 ? remaining : 0);
    }

    document.getElementById('new-sale-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveNewSale();
    });

    function saveNewSale() {
        const clientName = document.getElementById('sale-client-name').value.trim();
        const paymentType = document.getElementById('sale-payment-type').value;
        const productExpense = parseFloat(document.getElementById('sale-product-expense').value) || 0;
        const generateInvoice = document.getElementById('generate-invoice-checkbox').checked;

        if (!clientName || currentSaleCart.length === 0) {
            alert("Client name and at least one product are required.");
            return;
        }

        data.settings.lastSaleId++;
        const totalSale = currentSaleCart.reduce((sum, item) => sum + item.total, 0);
        const newSale = {
            id: data.settings.lastSaleId,
            date: new Date().toISOString().slice(0, 10),
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            clientName: clientName,
            paymentType: paymentType,
            productExpense: productExpense,
            isDebt: paymentType === 'Crédit',
            items: [...currentSaleCart], // Copier les éléments du panier
            total: totalSale
        };

        data.sales.push(newSale);

        // Mettre à jour le stock
        currentSaleCart.forEach(cartItem => {
            const product = getProductById(cartItem.id);
            if (product) {
                product.qty -= cartItem.qty;
            }
        });

        // Enregistrer la dépense spécifique au produit vendu
        if (productExpense > 0) {
            data.settings.lastExpenseId++;
            const saleExpense = {
                id: data.settings.lastExpenseId,
                date: newSale.date,
                description: `Expense for sale to ${clientName}`,
                category: 'Sale Expense',
                amount: productExpense,
                saleId: newSale.id
            };
            data.expenses.push(saleExpense);
        }

        if (newSale.isDebt) {
            const initialPayment = parseFloat(document.getElementById('debt-initial-payment').value) || 0;
            const remaining = totalSale - initialPayment;
            const dueDate = document.getElementById('debt-due-date').value;
            if (remaining > 0 && dueDate) {
                 data.settings.lastDebtId++;
                 const newDebt = {
                    id: data.settings.lastDebtId,
                    saleId: newSale.id,
                    clientName: clientName,
                    initialAmount: totalSale,
                    remaining: remaining,
                    dueDate: dueDate,
                    payments: [
                        { date: newSale.date, amount: initialPayment }
                    ]
                 };
                 data.debts.push(newDebt);
            }
        }

        logTask('add_sale', `Recorded sale to ${clientName}, Total: ${formatCurrency(totalSale)}`);
        persistData();
        renderSales();

        // Générer la facture si demandé
        if (generateInvoice) {
            generateInvoiceForSale(newSale);
        }

        // Afficher l'overlay de validation
        const overlay = document.createElement('div');
        overlay.className = 'sale-validation-overlay';
        overlay.innerHTML = `
            <div class="sale-validation-content">
                <i class="fas fa-check-circle"></i>
                <h3>Sale Completed!</h3>
                <p>Total: ${formatCurrency(newSale.total)}</p>
            </div>
        `;
        document.body.appendChild(overlay);

        // Fermer le modal et réinitialiser le panier après un délai
        setTimeout(() => {
            document.body.removeChild(overlay);
            const modal = bootstrap.Modal.getInstance(document.getElementById('newSaleModal'));
            if (modal) modal.hide();
            currentSaleCart = [];
            renderSaleCart(); // Réinitialiser le panier affiché
        }, 1500); // 1.5 secondes
    }

    function renderSales() {
        const tbody = document.getElementById('sales-table-body');
        if (!tbody) return;
        let sortedSales = [...data.sales].sort((a, b) => new Date(b.date) - new Date(a.date));

        // Filtres
        const searchTerm = document.querySelector('#sales-management input[placeholder*="client name"]')?.value.toLowerCase() || '';
        const productSearchTerm = document.querySelector('#sales-management input[placeholder*="product name"]')?.value.toLowerCase() || '';
        const statusFilter = document.querySelector('#sales-management select')?.value;

        sortedSales = sortedSales.filter(sale => {
            const matchesClient = sale.clientName.toLowerCase().includes(searchTerm);
            const matchesProduct = sale.items.some(item => item.name.toLowerCase().includes(productSearchTerm));
            const matchesStatus = statusFilter === 'all' || sale.paymentType === statusFilter;
            return matchesClient && matchesProduct && matchesStatus;
        });

        tbody.innerHTML = sortedSales.map(sale => {
            // Calculer les marges pour la première ligne d'articles
            const firstItem = sale.items[0];
            const product = firstItem ? getProductById(firstItem.id) : null;
            const costOfFirstItem = product ? (product.buyPrice * firstItem.qty) : 0;
            const grossMargin = sale.total - costOfFirstItem; // Cela peut être approximatif pour plusieurs produits
            const netMargin = grossMargin - (sale.productExpense || 0);

            const isDebt = sale.isDebt;
            const statusText = isDebt ? 'Crédit' : 'Espèces';
            const statusClass = isDebt ? 'badge bg-warning' : 'badge bg-success';

            // Afficher les noms des produits dans une cellule
            const productNames = sale.items.map(item => `${item.name} (x${item.qty})`).join(', ');

            return `
                <tr>
                    <td>${sale.date} ${sale.time}</td>
                    <td>${sale.clientName}</td>
                    <td>${productNames}</td>
                    <td>${sale.items.reduce((sum, item) => sum + item.qty, 0)}</td>
                    <td>${formatCurrency(sale.total)}</td>
                    <td class="${grossMargin < 0 ? 'text-danger' : 'text-success'}">${formatCurrency(grossMargin)}</td>
                    <td class="${netMargin < 0 ? 'text-danger' : 'text-success'}">${formatCurrency(netMargin)}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="generateInvoiceFromSale(${sale.id})">
                            <i class="fas fa-file-invoice"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="askDeleteSale(${sale.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // NOUVELLE FONCTION POUR DEMANDER LE MOT DE PASSE POUR SUPPRIMER UNE VENTE
    function askDeleteSale(saleId) {
        document.getElementById('sale-to-delete-id').value = saleId;
        const modal = new bootstrap.Modal(document.getElementById('deleteSalePasswordModal'));
        modal.show();
    }

    // NOUVELLE FONCTION POUR CONFIRMER LA SUPPRESSION
    function confirmDeleteSale() {
        const enteredPassword = document.getElementById('delete-sale-password').value;
        const saleId = parseInt(document.getElementById('sale-to-delete-id').value);
        if (enteredPassword === 'loghistory1') {
            deleteSale(saleId);
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteSalePasswordModal'));
            modal.hide();
            document.getElementById('delete-sale-password').value = '';
        } else {
            alert("Incorrect password.");
        }
    }

    // NOUVELLE FONCTION POUR SUPPRIMER UNE VENTE
    function deleteSale(saleId) {
        if (confirm("Are you sure you want to delete this sale? This action is irreversible. The associated invoice will remain.")) {
            const sale = data.sales.find(s => s.id === saleId);
            if (sale) {
                // Restaurer le stock des produits
                sale.items.forEach(item => {
                    const product = getProductById(item.id);
                    if (product) {
                        product.qty += item.qty;
                    }
                });
                // Supprimer les dettes associées
                data.debts = data.debts.filter(d => d.saleId !== saleId);
                // Supprimer les dépenses associées
                data.expenses = data.expenses.filter(e => e.saleId !== saleId);
                // Supprimer la vente
                data.sales = data.sales.filter(s => s.id !== saleId);
                // Ne PAS supprimer les factures associées
                logTask('delete_sale', `Deleted sale with ID: ${saleId}, Total: ${formatCurrency(sale.total)}`);
                persistData();
                renderSales();
                renderInvoices(); // Mettre à jour la liste des factures
                alert("Vente supprimée avec succès. La facture associée reste.");
            }
        }
    }

    // GESTION DES DETTES
    function renderDebts() {
        const tbody = document.getElementById('debts-table-body');
        if (!tbody) return;
        const currentDebts = data.debts.filter(d => d.remaining > 0).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        tbody.innerHTML = currentDebts.map(debt => {
            const isDueSoon = (new Date(debt.dueDate) - new Date()) <= (7 * 24 * 60 * 60 * 1000);
            const rowClass = isDueSoon ? 'table-danger' : '';
            return `
                <tr class="${rowClass}">
                    <td>${debt.clientName}</td>
                    <td>${debt.dueDate}</td>
                    <td>${formatCurrency(debt.initialAmount)}</td>
                    <td class="fw-bold text-danger">${formatCurrency(debt.remaining)}</td>
                    <td>
                        <button class="btn btn-sm btn-glass" onclick="recordDebtPayment(${debt.id})">
                            <i class="fas fa-hand-holding-usd"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    function recordDebtPayment(debtId) {
        const debt = data.debts.find(d => d.id === debtId);
        if (!debt) return;
        const paymentAmount = prompt(`Record a payment for ${debt.clientName}'s debt (Remaining: ${formatCurrency(debt.remaining)}). Payment amount:`);
        const amount = parseFloat(paymentAmount);
        if (isNaN(amount) || amount <= 0) return;
        if (amount > debt.remaining) return alert("Le paiement ne peut pas dépasser le montant restant.");

        const oldRemaining = debt.remaining;
        debt.remaining -= amount;
        debt.payments.push({ date: new Date().toISOString().slice(0, 10), amount: amount });

        logTask('record_payment', `Recorded payment of ${formatCurrency(amount)} for debt of ${debt.clientName}. Remaining: ${formatCurrency(debt.remaining)}`);

        // Générer une facture de paiement pour cette transaction
        generateInvoiceForDebtPayment(debt, amount, oldRemaining);

        persistData();
        renderDebts();
        alert(`Payment of ${formatCurrency(amount)} recorded. New remaining: ${formatCurrency(debt.remaining)}`);
    }

    // Fonction pour générer une facture de paiement de dette
    function generateInvoiceForDebtPayment(debt, currentPayment, previousBalance) {
        const sale = data.sales.find(s => s.id === debt.saleId);
        if (!sale) return; // Ne devrait pas arriver si les données sont cohérentes

        const client = data.clients.find(c => c.name === debt.clientName) || { phone: '', email: '' };

        const invoiceId = `PAY-${debt.id.toString().padStart(6, '0')}-${Date.now()}`;
        const newInvoice = {
            id: invoiceId,
            saleId: sale.id,
            debtId: debt.id, // Lier à la dette
            date: new Date().toISOString().slice(0, 10),
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            clientName: debt.clientName,
            clientPhone: client.phone,
            clientEmail: client.email,
            items: sale.items.map(item => ({ // Répéter les items de la vente originale
                name: item.name,
                specs: item.specs,
                unitPrice: item.unitPrice,
                qty: item.qty,
                total: item.total
            })),
            subtotal: sale.total - (sale.productExpense || 0),
            vatRate: data.settings.invoiceEnableVat ? data.settings.invoiceVatRate : 0,
            vatAmount: data.settings.invoiceEnableVat ? ((sale.total - (sale.productExpense || 0)) * data.settings.invoiceVatRate) / 100 : 0,
            total: sale.total,
            advancePaid: debt.initialAmount - previousBalance, // Montant déjà payé avant ce paiement
            currentPayment: currentPayment, // Montant de ce paiement
            newBalance: debt.remaining, // Solde restant après ce paiement
            dueDate: debt.dueDate,
            paymentType: 'Partial Payment',
            generatedAt: new Date().toISOString()
        };

        data.settings.invoices.push(newInvoice);
        logTask('generate_invoice_payment', `Generated payment invoice ${invoiceId} for debt of ${debt.clientName}, Payment: ${formatCurrency(currentPayment)}, New Balance: ${formatCurrency(debt.remaining)}`);
        persistData();
        renderInvoices();
    }

    // GESTION DES DÉPENSES (HORS VENTE)
    document.getElementById('expense-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('expense-id').value;
        const description = document.getElementById('expense-description').value.trim();
        const category = document.getElementById('expense-category').value;
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const date = document.getElementById('expense-date').value;
        if (!description || !category || isNaN(amount) || amount <= 0 || !date) {
             return alert("Please fill all fields correctly.");
        }
        if (id) {
            // Modification d'une dépense existante
            const expense = data.expenses.find(e => e.id == id);
            if (expense) {
                expense.description = description;
                expense.category = category;
                expense.amount = amount;
                expense.date = date;
            }
            logTask('update_expense', `Updated expense: ${description}, Amount: ${formatCurrency(amount)}`);
        } else {
            data.settings.lastExpenseId++;
            const newExpense = {
                id: data.settings.lastExpenseId,
                date: date,
                description: description,
                category: category,
                amount: amount
            };
            data.expenses.push(newExpense);
            logTask('add_expense', `Added new expense: ${description}, Amount: ${formatCurrency(amount)}`);
        }
        persistData();
        renderExpenses();
        this.reset();
        document.getElementById('expense-date').value = new Date().toISOString().slice(0, 10);
    });
    function renderExpenses() {
        const tbody = document.getElementById('expenses-table-body');
        if (!tbody) return;
        let sortedExpenses = [...data.expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

        // Filtres
        const descSearchTerm = document.querySelector('#expenses-management input[placeholder*="description"]')?.value.toLowerCase() || '';
        const categoryFilter = document.querySelector('#expenses-management select')?.value;
        const dateFilter = document.querySelector('#expenses-management input[type="date"]')?.value;

        sortedExpenses = sortedExpenses.filter(exp => {
            const matchesDesc = exp.description.toLowerCase().includes(descSearchTerm);
            const matchesCat = categoryFilter === 'all' || exp.category === categoryFilter;
            const matchesDate = !dateFilter || exp.date === dateFilter;
            return matchesDesc && matchesCat && matchesDate;
        });

        tbody.innerHTML = sortedExpenses.map(exp => `
            <tr>
                <td>${exp.date}</td>
                <td>${exp.description}</td>
                <td>${exp.category}</td>
                <td>${formatCurrency(exp.amount)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-info me-1" onclick="editExpense(${exp.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteExpense(${exp.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    function editExpense(id) {
        const expense = data.expenses.find(e => e.id === id);
        if (expense) {
            document.getElementById('expense-id').value = expense.id;
            document.getElementById('expense-description').value = expense.description;
            document.getElementById('expense-category').value = expense.category;
            document.getElementById('expense-amount').value = expense.amount;
            document.getElementById('expense-date').value = expense.date;
        }
    }
    function deleteExpense(id) {
        if (confirm("Supprimer cette dépense ?")) {
            data.expenses = data.expenses.filter(e => e.id !== id);
            logTask('delete_expense', `Deleted expense with ID: ${id}`);
            persistData();
            renderExpenses();
        }
    }
    // =================================================================
    // GESTION DES FACTURES
    // =================================================================
    function generateInvoiceForSale(sale) {
        const client = data.clients.find(c => c.name === sale.clientName) || { phone: '', email: '' };
        const subtotal = sale.total - (sale.productExpense || 0);
        const vatRate = data.settings.invoiceEnableVat ? data.settings.invoiceVatRate : 0;
        const vatAmount = (subtotal * vatRate) / 100;
        const totalWithVat = subtotal + vatAmount;

        const invoiceId = `INV-${data.settings.lastSaleId.toString().padStart(6, '0')}`;

        const newInvoice = {
            id: invoiceId,
            saleId: sale.id,
            date: sale.date,
            time: sale.time,
            clientName: sale.clientName,
            clientPhone: client.phone,
            clientEmail: client.email,
            items: sale.items.map(item => ({
                name: item.name,
                specs: item.specs,
                unitPrice: item.unitPrice,
                qty: item.qty,
                total: item.total
            })),
            subtotal: subtotal,
            vatRate: vatRate,
            vatAmount: vatAmount,
            total: totalWithVat,
            advancePaid: sale.isDebt ? (parseFloat(document.getElementById('debt-initial-payment').value) || 0) : 0, // Avance payée si dette
            currentPayment: 0, // Paiement courant pour une facture de vente initiale
            newBalance: sale.isDebt ? (totalWithVat - (parseFloat(document.getElementById('debt-initial-payment').value) || 0)) : totalWithVat, // Solde restant si dette
            dueDate: sale.isDebt ? document.getElementById('debt-due-date').value : '',
            paymentType: sale.paymentType,
            generatedAt: new Date().toISOString()
        };

        data.settings.invoices.push(newInvoice);
        logTask('generate_invoice', `Generated invoice ${invoiceId} for sale to ${sale.clientName}, Total: ${formatCurrency(sale.total)}`);
        persistData();
        renderInvoices();
        // Pas d'alerte ici, l'overlay de validation suffit
    }

    // Nouvelle fonction pour générer une facture depuis l'historique des ventes
    function generateInvoiceFromSale(saleId) {
        const sale = data.sales.find(s => s.id === saleId);
        if (sale && !data.settings.invoices.some(inv => inv.saleId === saleId && !inv.debtId)) { // Vérifier si une facture *principale* existe déjà (pas une facture de paiement)
            generateInvoiceForSale(sale);
            alert(`Invoice generated for sale to ${sale.clientName}.`);
        } else if (data.settings.invoices.some(inv => inv.saleId === saleId && !inv.debtId)) {
            alert("Une facture existe déjà pour cette vente.");
        }
    }

    function renderInvoices() {
        const tbody = document.getElementById('invoices-table-body');
        if (!tbody) return;
        let sortedInvoices = [...data.settings.invoices].sort((a, b) => new Date(b.generatedAt) - new Date(a.generatedAt));

        // Filtres
        const numberSearchTerm = document.querySelector('#invoices-management input[placeholder*="invoice number"]')?.value.toLowerCase() || '';
        const clientSearchTerm = document.querySelector('#invoices-management input[placeholder*="client name"]')?.value.toLowerCase() || '';
        const dateFilter = document.querySelector('#invoices-management input[type="date"]')?.value;

        sortedInvoices = sortedInvoices.filter(inv => {
            const matchesNumber = inv.id.toLowerCase().includes(numberSearchTerm);
            const matchesClient = inv.clientName.toLowerCase().includes(clientSearchTerm);
            const matchesDate = !dateFilter || inv.date === dateFilter;
            return matchesNumber && matchesClient && matchesDate;
        });

        tbody.innerHTML = sortedInvoices.map(inv => `
            <tr>
                <td>${inv.id}</td>
                <td>${inv.date} ${inv.time}</td>
                <td>${inv.clientName}</td>
                <td>${formatCurrency(inv.total)}</td>
                <td>
                    <button class="btn btn-sm btn-glass" onclick="viewInvoice('${inv.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-glass-secondary ms-1" onclick="downloadInvoice('${inv.id}')">
                        <i class="fas fa-download"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function viewInvoice(invoiceId) {
        const invoice = data.settings.invoices.find(inv => inv.id === invoiceId);
        if (!invoice) return;

        const container = document.getElementById('invoice-container-template').cloneNode(true);
        container.id = 'current-invoice-container';
        container.style.display = 'block';
        container.style.position = 'fixed';
        container.style.top = '0';
        container.style.left = '0';
        container.style.width = '100%';
        container.style.height = '100%';
        container.style.backgroundColor = 'rgba(0,0,0,0.8)';
        container.style.zIndex = '10000';
        container.style.overflow = 'auto';

        const invoiceBody = container.querySelector('.invoice');
        // Remplir les infos de l'entreprise
        invoiceBody.querySelector('#invoice-company-name').textContent = data.settings.invoiceCompanyName || 'COMPANY NAME';
        invoiceBody.querySelector('#invoice-company-slogan').textContent = data.settings.invoiceCompanySlogan || 'SLOGAN';
        invoiceBody.querySelector('#invoice-company-address').textContent = data.settings.invoiceCompanyAddress || 'ADDRESS';
        invoiceBody.querySelector('#invoice-company-contact').textContent = data.settings.invoiceCompanyContact || 'CONTACT';
        invoiceBody.querySelector('#invoice-company-extra').textContent = data.settings.invoiceCompanyExtra || 'INFOS SUPPLÉMENTAIRES';
        invoiceBody.querySelector('#invoice-company-extra-footer').textContent = data.settings.invoiceCompanyExtra || 'INFOS SUPPLÉMENTAIRES';

        // Remplir les infos de la facture
        invoiceBody.querySelector('#invoice-number').textContent = invoice.id;
        invoiceBody.querySelector('#invoice-date-time').textContent = `${invoice.date} ${invoice.time}`;
        invoiceBody.querySelector('.client-name').textContent = invoice.clientName;
        invoiceBody.querySelector('.client-phone').textContent = invoice.clientPhone || 'N/A';
        invoiceBody.querySelector('.client-email').textContent = invoice.clientEmail || 'N/A';

        // Remplir le tableau des articles
        const itemsTbody = invoiceBody.querySelector('.invoice-items');
        itemsTbody.innerHTML = '';
        invoice.items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.name}</td>
                <td>${item.specs}</td>
                <td>${formatCurrency(item.unitPrice)}</td>
                <td>${item.qty}</td>
                <td>${formatCurrency(item.total)}</td>
            `;
            itemsTbody.appendChild(row);
        });

        // Remplir les totaux
        invoiceBody.querySelector('#invoice-subtotal').textContent = formatCurrency(invoice.subtotal);
        const vatRow = invoiceBody.querySelector('.vat-row');
        const vatAmountSpan = invoiceBody.querySelector('#invoice-vat-amount');
        if (data.settings.invoiceEnableVat && invoice.vatRate > 0) {
            vatRow.style.display = 'flex';
            vatAmountSpan.textContent = formatCurrency(invoice.vatAmount);
        } else {
            vatRow.style.display = 'none';
        }
        invoiceBody.querySelector('#invoice-total-amount').textContent = `**${formatCurrency(invoice.total)}**`;

        // Remplir le montant en lettres
        const amountInWords = numberToWords(invoice.total);
        invoiceBody.querySelector('#invoice-amount-words').textContent = amountInWords;

        // Remplir les infos de dette/paiement si applicable
        const advanceSection = invoiceBody.querySelector('.advance-section');
        const paymentSection = invoiceBody.querySelector('.payment-section');
        const balanceSection = invoiceBody.querySelector('.balance-section');
        const dueDateSection = invoiceBody.querySelector('.due-date-section');
        const advancePaidSpan = invoiceBody.querySelector('#invoice-advance-paid');
        const currentPaymentSpan = invoiceBody.querySelector('#invoice-current-payment');
        const newBalanceSpan = invoiceBody.querySelector('#invoice-new-balance');
        const dueDateSpan = invoiceBody.querySelector('#invoice-due-date');

        if (invoice.advancePaid !== undefined) {
            advanceSection.style.display = 'flex';
            advancePaidSpan.textContent = formatCurrency(invoice.advancePaid);
            if (invoice.currentPayment > 0) {
                paymentSection.style.display = 'flex';
                currentPaymentSpan.textContent = formatCurrency(invoice.currentPayment);
            } else {
                paymentSection.style.display = 'none';
            }
            balanceSection.style.display = 'flex';
            newBalanceSpan.textContent = formatCurrency(invoice.newBalance);
            dueDateSection.style.display = 'flex';
            dueDateSpan.textContent = invoice.dueDate || 'N/A';
        } else {
            advanceSection.style.display = 'none';
            paymentSection.style.display = 'none';
            balanceSection.style.display = 'none';
            dueDateSection.style.display = 'none';
        }

        // Remplir le message personnalisé
        invoiceBody.querySelector('#invoice-message').innerHTML = data.settings.invoiceMessage || 'Message personnalisé ici.';

        // Remplir le code-barres
        invoiceBody.querySelector('#invoice-barcode').textContent = `*${invoice.id}*`;

        // Logo de la facture
        const logoPreview = invoiceBody.querySelector('#invoice-logo-preview');
        if (data.settings.invoiceLogo) {
            logoPreview.src = data.settings.invoiceLogo;
            logoPreview.style.display = 'block';
        } else {
            logoPreview.style.display = 'none';
        }

        // Bouton de fermeture
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '&times;';
        closeBtn.style.position = 'absolute';
        closeBtn.style.top = '10px';
        closeBtn.style.right = '10px';
        closeBtn.style.fontSize = '2em';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.zIndex = '10001';
        closeBtn.style.color = 'white';
        closeBtn.style.background = 'none';
        closeBtn.style.border = 'none';
        closeBtn.onclick = () => document.body.removeChild(container);
        container.appendChild(closeBtn);

        document.body.appendChild(container);

        // Gestion du bouton de partage
        const shareButton = container.querySelector('#invoice-share-toggle-button');
        const shareMenu = container.querySelector('#invoice-share-menu');
        const clientPhone = invoice.clientPhone;
        const clientEmail = invoice.clientEmail;

        shareButton.onclick = function(event) {
            event.stopPropagation();
            shareMenu.classList.toggle('active');
        };

        document.addEventListener('click', function(event) {
            if (!shareButton.contains(event.target) && !shareMenu.contains(event.target)) {
                shareMenu.classList.remove('active');
            }
        });

        let shareOptions = '';
        if (clientEmail && clientEmail !== '') {
            shareOptions += `<div class="invoice-share-menu-item" onclick="simulateShare('email', '${clientEmail}', '${invoice.id}')">📧 Email</div>`;
        }
        if (clientPhone && clientPhone !== '') {
            shareOptions += `<div class="invoice-share-menu-item" onclick="simulateShare('whatsapp', '${clientPhone}', '${invoice.id}')">🟢 WhatsApp</div>`;
        }
        shareMenu.innerHTML = shareOptions;
    }

    function downloadInvoice(invoiceId) {
        const invoice = data.settings.invoices.find(inv => inv.id === invoiceId);
        if (!invoice) return;

        // Créer un conteneur temporaire pour la facture à imprimer
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Invoice ${invoiceId}</title>
                <style>
                    /* Copier les styles CSS de la facture ici */
                    body{font-family: 'Open Sans', 'Helvetica Neue', Arial, sans-serif;margin:5px;background:#f8f8f8; color: #333;}
                    .invoice{background-color: white;padding:25px;border:1px solid #ddd;box-shadow:0 4px 15px rgba(0,0,0,0.05);position: relative;overflow: hidden;font-size: 10pt;line-height: 1.5; max-width: 800px;margin: 10px auto; min-height: auto; }
                    .watermark-logo {position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%) rotate(-25deg);font-family: 'Playfair Display', serif;font-size: 5em;font-weight: bold;color: #000;opacity: 0.05;text-shadow: none;pointer-events: none;white-space: nowrap;z-index: 1;}
                    .invoice-header{text-align:center;border-bottom:2px solid #333;padding-bottom:10px;margin-bottom:10px}
                    .invoice-header h2{margin:0; font-size: 1.8em; color: #333; text-transform: uppercase; letter-spacing: 3px;font-family: 'Montserrat', sans-serif;font-weight: 700;}
                    .invoice-header .description{font-style: italic; font-size: 0.85em; margin: 5px 0 5px 0; color: #666;}
                    .invoice-header p{margin: 0; font-size: 0.75em; line-height: 1.3; color: #555;}
                    .total-row{display:flex;justify-content:space-between;margin-top:6px;padding-top:6px;border-top:1px solid #ccc;font-weight:bold;font-size:1em;}
                    .item-row{display:flex;justify-content:space-between;margin-bottom:3px;font-size:0.95em;}
                    .barcode{text-align:center;margin:8px 0;font-size:18px; color: #333;}
                    .articles-table{width:100%;border-collapse:collapse;margin-bottom:10px;font-size:0.9em;}
                    .articles-table th, .articles-table td{text-align:right;padding:5px 5px;}
                    .articles-table th:first-child, .articles-table td:first-child{text-align:left; width: 25%}
                    .articles-table th:nth-child(2), .articles-table td:nth-child(2){text-align:left; width: 35%}
                    .articles-table th:nth-child(3), .articles-table td:nth-child(3){width: 15%}
                    .articles-table th:nth-child(4), .articles-table td:nth-child(4){width: 10%}
                    .articles-table th:nth-child(5), .articles-table td:nth-child(5){width: 15%}
                    .articles-table th{border-bottom:1px solid #999;font-weight:bold;padding-bottom:5px;text-transform:uppercase; color: #333;}
                    .articles-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
                    .invoice-info{display:flex; flex-wrap: wrap; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 5px; padding-left: 5px; padding-right: 5px;}
                    .invoice-info dt{font-weight:bold; width: 30%; color: #555;}
                    .invoice-info dd{width: 70%; margin-left: 0; text-align: right; color: #333;}
                    .invoice-info div{display:flex; width: 100%; margin-bottom: 3px;}
                    .invoice-info dt, .invoice-info dd{font-size: 0.85em;}
                    .important-note {margin: 15px 0; padding: 8px; border-left: 3px solid #666;background-color: #f0f0f0;font-size: 0.8em; text-align: left;color: #444;line-height: 1.4;}
                    .signature-area{display:flex; justify-content:space-between; margin-top: 20px; padding-top: 10px;}
                    .signature-block{width: 45%; text-align: center; border-top: 1px dashed #999; padding-top: 5px; font-size: 0.8em; color: #555;}
                    .invoice-footer{border-top: 1px dashed #ddd; padding-top: 10px; text-align: center; font-size: 0.75em; color: #777;}
                    @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&family=Montserrat:wght@700&family=Playfair+Display:wght@700&display=swap');
                    @media print{ @page { margin: 0; } .articles-table thead {display: table-header-group;}.articles-table tr {page-break-inside: avoid;} html, body {-webkit-print-color-adjust: exact; color-adjust: exact; background: white;font-family: 'Open Sans', Arial, sans-serif;-webkit-font-smoothing: antialiased;-moz-osx-font-smoothing: grayscale;} body{padding:0;width: 210mm;margin: 0;} .invoice{box-shadow:none; border: 1px solid #000; padding: 10mm 15mm; margin: 0; max-width: none;height: auto; min-height: unset; background-color: #FFF !important;}.invoice-header .contact-info-address, .invoice-footer, .invoice-button-container {display: none;}.watermark-logo {opacity: 0.05;color: #000 !important; font-size: 4em;background-color: transparent !important;}.invoice-body {background-color: transparent !important;}h2, .total-row, .articles-table th, .articles-table td, .invoice-info dt, .invoice-info dd {color: #000 !important;background-color: transparent !important;}.articles-table tbody tr:nth-child(even) { background-color: #FFF !important; }.important-note {background-color: #f5f5f5 !important;border-color: #666 !important;color: #000 !important;}.signature-block, .invoice-footer {color: #000 !important;}.signature-block {border-top-color: #000 !important;}.invoice-header {border-bottom-color: #000 !important;}}
                </style>
                <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&family=Montserrat:wght@700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
            </head>
            <body>
                <div class="invoice">
                    <div class="watermark-logo">${data.settings.invoiceWatermark || 'FILIGRANE'}</div>
                    <div class="invoice-body">
                        <div class="invoice-header">
                            <img id="invoice-logo-preview" src="${data.settings.invoiceLogo || ''}" alt="Logo" style="max-height: 80px; max-width: 200px; display: ${data.settings.invoiceLogo ? 'block' : 'none'}; margin-bottom: 15px; object-fit: contain;">
                            <h2>${data.settings.invoiceCompanyName || 'COMPANY NAME'}</h2>
                            <p class="description">${data.settings.invoiceCompanySlogan || 'SLOGAN'}</p>
                            <p id="invoice-company-address">${data.settings.invoiceCompanyAddress || 'ADDRESS'}</p>
                            <p id="invoice-company-contact">${data.settings.invoiceCompanyContact || 'CONTACT'}</p>
                            <p id="invoice-company-extra">${data.settings.invoiceCompanyExtra || 'INFOS SUPPLÉMENTAIRES'}</p>
                        </div>
                        <div>
                            <dl class="invoice-info">
                                <div><dt>Facture N°</dt><dd>${invoice.id}</dd></div>
                                <div><dt>Date & Heure</dt><dd>${invoice.date} ${invoice.time}</dd></div>
                                <div><dt>Client</dt><dd>${invoice.clientName}</dd></div>
                                <div><dt>Téléphone du client</dt><dd>${invoice.clientPhone || 'N/A'}</dd></div>
                                <div><dt>Email du client</dt><dd>${invoice.clientEmail || 'N/A'}</dd></div>
                            </dl>
                            <table class="articles-table">
                                <thead>
                                    <tr>
                                        <th>Product/Service</th>
                                        <th>Spécifications</th>
                                        <th>Prix Unitaire</th>
                                        <th>Qté</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${invoice.items.map(item => `
                                        <tr>
                                            <td>${item.name}</td>
                                            <td>${item.specs}</td>
                                            <td>${formatCurrency(item.unitPrice)}</td>
                                            <td>${item.qty}</td>
                                            <td>${formatCurrency(item.total)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <div class="total-row"><span>SUBTOTAL (HT)</span><span>${formatCurrency(invoice.subtotal)}</span></div>
                            ${data.settings.invoiceEnableVat && invoice.vatRate > 0 ? `<div class="item-row"><span>VAT (${invoice.vatRate}%)</span><span>${formatCurrency(invoice.vatAmount)}</span></div>` : ''}
                            <div class="total-row" style="margin-top:10px; border-top:2px solid #333; font-size:1.1em;">
                                <span>TOTAL NET À PAYER</span>
                                <span>**${formatCurrency(invoice.total)}**</span>
                            </div>
                            <div class="item-row"><span>Amount in Letters:</span><span>${numberToWords(invoice.total)}</span></div>
                            ${invoice.advancePaid !== undefined ? `
                                <div class="item-row"><span>Advance Paid:</span><span>${formatCurrency(invoice.advancePaid)}</span></div>
                                ${invoice.currentPayment > 0 ? `<div class="item-row"><span>Current Payment:</span><span>${formatCurrency(invoice.currentPayment)}</span></div>` : ''}
                                <div class="item-row"><span>New Remaining Balance:</span><span>${formatCurrency(invoice.newBalance)}</span></div>
                                <div class="item-row"><span>Due Date:</span><span>${invoice.dueDate || 'N/A'}</span></div>
                            ` : ''}
                            <div class="important-note">
                                ${data.settings.invoiceMessage || 'Message personnalisé ici.'}
                            </div>
                            <div class="signature-area">
                                <div class="signature-block">Customer Signature</div>
                                <div class="signature-block">Seller Signature</div>
                            </div>
                        </div>
                        <div class="invoice-footer">
                            <p>${data.settings.invoiceCompanyExtra || 'INFOS SUPPLÉMENTAIRES'}</p>
                            <div class="barcode">*${invoice.id}*</div>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
    }

    function simulateShare(method, target, invoiceId) {
        if (method === 'whatsapp') {
            alert(`SIMULATION: Invoice ${invoiceId} sent to phone: ${target}.`);
        } else if (method === 'email') {
            alert(`SIMULATION: Invoice ${invoiceId} sent to email: ${target}.`);
        }
        // Fermer le menu
        const menu = document.querySelector('#current-invoice-container .invoice-share-menu');
        if (menu) menu.classList.remove('active');
    }

    function exportInvoicesToCSV() {
        let csvContent = "Invoice #,Date,Time,Client,Total,Payment Type,Generated At\n";
        data.settings.invoices.forEach(inv => {
            csvContent += `"${inv.id}","${inv.date}","${inv.time}","${inv.clientName}",${inv.total},"${inv.paymentType}","${inv.generatedAt}"\n`;
        });
        downloadCSV(csvContent, 'alpha_pro_invoices.csv');
    }

    // =================================================================
    // ANALYTICS ET RAPPORTS
    // =================================================================
    function updateAnalytics() {
        updateSalesTrendChart();
        updateTopProductsChart();
        updateTopClientsChart();
        updateSalesByWeekdayChart();
    }
    function updateSalesTrendChart() {
        const ctx = document.getElementById('salesTrendChart')?.getContext('2d');
        if (!ctx) return;
        if (charts.salesTrendChart) charts.salesTrendChart.destroy();
        // Filtrer les données selon la période sélectionnée
        const period = document.getElementById('analytics-period').value;
        const startDate = document.getElementById('analytics-date-start').value;
        const endDate = document.getElementById('analytics-date-end').value;
        let filteredSales = [...data.sales];
        if (period === 'custom' && startDate && endDate) {
            filteredSales = filteredSales.filter(s => s.date >= startDate && s.date <= endDate);
        } else {
            const today = new Date();
            let start = new Date();
            switch(period) {
                case '7days':
                    start.setDate(today.getDate() - 7);
                    break;
                case '30days':
                    start.setDate(today.getDate() - 30);
                    break;
                case '90days':
                    start.setDate(today.getDate() - 90);
                    break;
                case 'year':
                    start.setFullYear(today.getFullYear(), 0, 1);
                    break;
            }
            filteredSales = filteredSales.filter(s => new Date(s.date) >= start);
        }
        // Grouper par jour
        const dailySales = filteredSales.reduce((acc, sale) => {
            if (!acc[sale.date]) acc[sale.date] = 0;
            acc[sale.date] += sale.total;
            return acc;
        }, {});
        const labels = Object.keys(dailySales).sort();
        const salesData = labels.map(date => dailySales[date]);
        charts.salesTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ventes quotidiennes',
                    data: salesData,
                    borderColor: 'rgb(102, 126, 234)',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `Sales: ${formatCurrency(context.parsed.y)}`,
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }
    function updateTopProductsChart() {
        const ctx = document.getElementById('topProductsChart')?.getContext('2d');
        if (!ctx) return;
        if (charts.topProductsChart) charts.topProductsChart.destroy();
        // Calculer le total des ventes par produit
        const productSales = data.sales.reduce((acc, sale) => {
            sale.items.forEach(item => {
                if (!acc[item.name]) acc[item.name] = 0;
                acc[item.name] += item.total;
            });
            return acc;
        }, {});
        // Trier et prendre les 10 premiers
        const sortedProducts = Object.entries(productSales)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
        const labels = sortedProducts.map(item => item[0]);
        const salesData = sortedProducts.map(item => item[1]);
        charts.topProductsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ventes totales',
                    data: salesData,
                    backgroundColor: 'rgba(118, 75, 162, 0.7)',
                    borderColor: 'rgb(118, 75, 162)',
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `Sales: ${formatCurrency(context.parsed.y)}`,
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }
    function updateTopClientsChart() {
        const ctx = document.getElementById('topClientsChart')?.getContext('2d');
        if (!ctx) return;
        if (charts.topClientsChart) charts.topClientsChart.destroy();
        // Calculer le total des achats par client
        const clientPurchases = data.sales.reduce((acc, sale) => {
            if (!acc[sale.clientName]) acc[sale.clientName] = 0;
            acc[sale.clientName] += sale.total;
            return acc;
        }, {});
        // Trier et prendre les 10 premiers
        const sortedClients = Object.entries(clientPurchases)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
        const labels = sortedClients.map(item => item[0]);
        const purchaseData = sortedClients.map(item => item[1]);
        charts.topClientsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Achats totaux',
                    data: purchaseData,
                    backgroundColor: 'rgba(104, 211, 145, 0.7)',
                    borderColor: 'rgb(104, 211, 145)',
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `Purchases: ${formatCurrency(context.parsed.y)}`,
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }
    function updateSalesByWeekdayChart() {
        const ctx = document.getElementById('salesByWeekdayChart')?.getContext('2d');
        if (!ctx) return;
        if (charts.salesByWeekdayChart) charts.salesByWeekdayChart.destroy();
        const weekdays = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
        const salesByWeekday = [0, 0, 0, 0, 0, 0, 0];
        data.sales.forEach(sale => {
            const date = new Date(sale.date);
            const weekday = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
            salesByWeekday[weekday] += sale.total;
        });
        charts.salesByWeekdayChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: weekdays,
                datasets: [{
                    label: 'Ventes par jour',
                    data: salesByWeekday,
                    backgroundColor: 'rgba(246, 173, 85, 0.7)',
                    borderColor: 'rgb(246, 173, 85)',
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `Sales: ${formatCurrency(context.parsed.y)}`,
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }
    function exportAnalyticsPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const margin = 10;
        let y = margin;
        const pageWidth = doc.internal.pageSize.getWidth();
        // Titre
        doc.setFontSize(18);
        doc.text("Rapport d'Analyse AB-APP Pro", pageWidth / 2, y, { align: 'center' });
        y += 10;
        html2canvas(document.getElementById('dashboard-container-kpis')).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = pageWidth - 2 * margin;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            doc.addImage(imgData, 'PNG', margin, y, imgWidth, imgHeight);
            y += imgHeight + 5;
            doc.setFontSize(12);
            doc.text("Statistiques détaillées et graphiques non inclus dans l'exportation simple.", margin, y + 5);
            doc.save('Rapport_Analyse_AB-APP.pdf');
        }).catch(error => {
            console.error("Error generating PDF: ", error);
            alert("Erreur lors de la génération du PDF.");
        });
    }
    // =================================================================
    // GESTION DES PARAMÈTRES
    // =================================================================
    function loadSettingsPage() {
        document.getElementById('setting-company-name').value = data.settings.companyName;
        document.getElementById('setting-company-slogan').value = data.settings.companySlogan;
        document.getElementById('setting-language').value = data.settings.language;
        document.getElementById('setting-currency').value = data.settings.currencySymbol;
        document.getElementById('setting-low-stock-threshold').value = data.settings.lowStockThreshold;
        const logoPreview = document.getElementById('setting-logo-preview');
        if (data.settings.logo) {
            logoPreview.src = data.settings.logo;
            logoPreview.style.display = 'block';
        } else {
            logoPreview.style.display = 'none';
        }

        // Charger les paramètres de facturation
        document.getElementById('invoice-company-name').value = data.settings.invoiceCompanyName || '';
        document.getElementById('invoice-company-slogan').value = data.settings.invoiceCompanySlogan || '';
        document.getElementById('invoice-company-address').value = data.settings.invoiceCompanyAddress || '';
        document.getElementById('invoice-company-contact').value = data.settings.invoiceCompanyContact || '';
        document.getElementById('invoice-company-extra').value = data.settings.invoiceCompanyExtra || '';
        document.getElementById('invoice-watermark').value = data.settings.invoiceWatermark || '';
        document.getElementById('invoice-message').value = data.settings.invoiceMessage || '';
        document.getElementById('invoice-enable-vat').checked = data.settings.invoiceEnableVat;
        document.getElementById('invoice-vat-rate').value = data.settings.invoiceVatRate;
        toggleVatRateField(); // Afficher/cacher le champ TVA

        const invoiceLogoPreview = document.getElementById('invoice-logo-preview');
        if (data.settings.invoiceLogo) {
            invoiceLogoPreview.src = data.settings.invoiceLogo;
            invoiceLogoPreview.style.display = 'block';
        } else {
            invoiceLogoPreview.style.display = 'none';
        }
    }

    document.getElementById('settings-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const newCompanyName = document.getElementById('setting-company-name').value.trim();
        const newCompanySlogan = document.getElementById('setting-company-slogan').value.trim();
        const newLanguage = document.getElementById('setting-language').value;
        const newCurrency = document.getElementById('setting-currency').value.trim();
        const newThreshold = parseInt(document.getElementById('setting-low-stock-threshold').value) || 0;
        const logoFile = document.getElementById('setting-logo').files[0];
        const logoBase64 = await fileToBase64(logoFile);

        data.settings.companyName = newCompanyName || 'ALPHA PRO';
        data.settings.companySlogan = newCompanySlogan || 'Intelligent Management';
        data.settings.language = newLanguage;
        data.settings.currencySymbol = newCurrency || 'FCFA';
        data.settings.lowStockThreshold = newThreshold;
        if (logoBase64) data.settings.logo = logoBase64;

        persistData();
        changeLanguage(newLanguage);
        updateHeaderInfo();
        alert("Paramètres généraux enregistrés avec succès !");
        document.getElementById('setting-logo').value = '';
        loadSettingsPage();
    });

    document.getElementById('invoice-settings-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const newInvoiceCompanyName = document.getElementById('invoice-company-name').value.trim();
        const newInvoiceCompanySlogan = document.getElementById('invoice-company-slogan').value.trim();
        const newInvoiceCompanyAddress = document.getElementById('invoice-company-address').value.trim();
        const newInvoiceCompanyContact = document.getElementById('invoice-company-contact').value.trim();
        const newInvoiceCompanyExtra = document.getElementById('invoice-company-extra').value.trim();
        const newInvoiceWatermark = document.getElementById('invoice-watermark').value.trim();
        const newInvoiceMessage = document.getElementById('invoice-message').value.trim();
        const enableVat = document.getElementById('invoice-enable-vat').checked;
        const vatRate = parseFloat(document.getElementById('invoice-vat-rate').value) || 0;
        const logoFile = document.getElementById('invoice-logo').files[0];
        const logoBase64 = await fileToBase64(logoFile);

        data.settings.invoiceCompanyName = newInvoiceCompanyName || 'Votre Entreprise';
        data.settings.invoiceCompanySlogan = newInvoiceCompanySlogan || 'Votre Slogan';
        data.settings.invoiceCompanyAddress = newInvoiceCompanyAddress || 'Votre Adresse';
        data.settings.invoiceCompanyContact = newInvoiceCompanyContact || 'Tél : 000 000 000 | Email : contact@entreprise.com';
        data.settings.invoiceCompanyExtra = newInvoiceCompanyExtra || 'NUI : 0000000000000';
        data.settings.invoiceWatermark = newInvoiceWatermark || 'VOTRE ENTREPRISE';
        data.settings.invoiceMessage = newInvoiceMessage || 'Merci pour votre achat !';
        data.settings.invoiceEnableVat = enableVat;
        data.settings.invoiceVatRate = vatRate;
        if (logoBase64) data.settings.invoiceLogo = logoBase64;

        persistData();
        alert("Paramètres de facture enregistrés avec succès !");
        document.getElementById('invoice-logo').value = '';
        loadSettingsPage();
    });

    function toggleVatRateField() {
        const enableVat = document.getElementById('invoice-enable-vat').checked;
        const vatRateContainer = document.getElementById('vat-rate-container');
        vatRateContainer.style.display = enableVat ? 'block' : 'none';
    }
    document.getElementById('invoice-enable-vat').addEventListener('change', toggleVatRateField);

    function updateHeaderInfo() {
        const logoImg = document.getElementById('nav-logo');
        const companyNameDisplay = document.getElementById('company-name-display');
        const companySlogan = document.getElementById('company-slogan');
        companyNameDisplay.textContent = data.settings.companyName;
        companySlogan.textContent = data.settings.companySlogan;
        if (data.settings.logo) {
            logoImg.src = data.settings.logo;
            logoImg.style.display = 'block';
        } else {
            logoImg.src = '';
            logoImg.style.display = 'none';
        }
    }
    // =================================================================
    // DASHBOARD STATS & FILTERS
    // =================================================================
    function filterDataByDate(startDate, endDate, categoryId, productId) {
        const start = startDate ? new Date(startDate) : null;
        const end = endDate ? new Date(endDate) : null;
        const filterByDate = (item) => {
            if (!item.date) return false;
            const itemDate = new Date(item.date);
            if (start && itemDate < start) return false;
            if (end && itemDate > end) return false;
            return true;
        };
        const filterByProduct = (item) => {
            if (productId === 'all') return true;
            // Pour les ventes, on vérifie si l'un des produits du panier correspond
            if (item.items) {
                return item.items.some(i => i.id == productId);
            }
            return item.productId && item.productId == productId;
        };
        const filterByCategory = (item) => {
             if (categoryId === 'all') return true;
             // Pour les ventes, on vérifie si l'un des produits du panier appartient à la catégorie
             if (item.items) {
                 return item.items.some(i => {
                     const product = getProductById(i.id);
                     return product && product.categoryId == categoryId;
                 });
             }
             const product = item.productId ? getProductById(item.productId) : null;
             return product && product.categoryId == categoryId;
        };
        const filteredSales = data.sales.filter(filterByDate).filter(filterByProduct).filter(filterByCategory);
        const filteredExpenses = data.expenses.filter(filterByDate);
        const filteredDebts = data.debts.filter(d => filterByDate(data.sales.find(s => s.id === d.saleId)));
        return { sales: filteredSales, expenses: filteredExpenses, debts: filteredDebts };
    }
    function calculateDashboardStats(filteredData) {
        let totalSales = 0;
        let totalCost = 0;
        let qtySold = 0;
        let totalExpenses = 0;
        let totalDebtsDue = 0;
        let lowStockCount = 0;
        let totalProductExpenses = 0;
        filteredData.sales.forEach(sale => {
            totalSales += sale.total;
            sale.items.forEach(item => qtySold += item.qty);
            sale.items.forEach(item => {
                const product = getProductById(item.id);
                const costOfItem = product ? (product.buyPrice * item.qty) : 0;
                totalCost += costOfItem;
            });
            // Ajouter les dépenses spécifiques au produit
            totalProductExpenses += (sale.productExpense || 0);
        });
        filteredData.expenses.forEach(exp => {
            totalExpenses += exp.amount;
        });
        const currentDebts = data.debts.filter(d => d.remaining > 0);
        const uniqueClientDebts = new Set(currentDebts.map(d => d.clientName)).size;
        currentDebts.forEach(d => {
             totalDebtsDue += d.remaining;
        });
        lowStockCount = data.products.filter(p => p.qty <= p.alertQty && p.alertQty > 0).length;
        // Calcul de la marge brute et nette selon l'exemple donné
        const grossMargin = totalSales - totalCost;
        const netMargin = grossMargin - totalProductExpenses;
        const netProfit = netMargin - totalExpenses;
        const avgSaleValue = filteredData.sales.length > 0 ? totalSales / filteredData.sales.length : 0;
        return {
            netProfit: netProfit,
            totalSales: totalSales,
            totalCost: totalCost,
            qtySold: qtySold,
            totalExpenses: totalExpenses,
            totalDebtsDue: totalDebtsDue,
            debtsCount: uniqueClientDebts,
            grossMargin: grossMargin,
            netMargin: netMargin,
            avgSaleValue: avgSaleValue, 
            lowStockCount: lowStockCount 
        };
    }
    function updateDashboard() {
        const startDate = document.getElementById('filter-date-start').value;
        const endDate = document.getElementById('filter-date-end').value;
        const categoryId = document.getElementById('filter-category').value;
        const productId = document.getElementById('filter-product').value;
        const filteredData = filterDataByDate(startDate, endDate, categoryId, productId);
        const stats = calculateDashboardStats(filteredData);
        document.getElementById('kpi-net-profit').textContent = formatCurrency(stats.netProfit);
        document.getElementById('kpi-total-sales').textContent = formatCurrency(stats.totalSales);
        document.getElementById('kpi-qty-sold').textContent = `${stats.qtySold} units`;
        document.getElementById('kpi-debts-due').textContent = formatCurrency(stats.totalDebtsDue);
        document.getElementById('kpi-gross-margin').textContent = formatCurrency(stats.grossMargin);
        document.getElementById('kpi-net-margin').textContent = formatCurrency(stats.netMargin);
        document.getElementById('sales-count').textContent = `${filteredData.sales.length} transactions`;
        document.getElementById('due-count').textContent = `${stats.debtsCount} clients`;
        document.getElementById('kpi-total-expenses').textContent = formatCurrency(stats.totalExpenses);
        document.getElementById('kpi-low-stock-count').textContent = `${stats.lowStockCount} products`;
        if (stats.lowStockCount > 0) {
            document.getElementById('kpi-low-stock-card').classList.add('kpi-critical');
        } else {
             document.getElementById('kpi-low-stock-card').classList.remove('kpi-critical');
        }
        // Mise à jour du carousel des dettes
        updateDebtCarousel();
        updateProfitChart(filteredData);
        updateExpenseCategoryChart(filteredData);
        updateStockByCategoryChart();
    }

    function updateDebtCarousel() {
        const carouselInner = document.getElementById('debt-carousel-inner');
        if (!carouselInner) return;
        const currentDebts = data.debts.filter(d => d.remaining > 0).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        if (currentDebts.length === 0) {
            carouselInner.innerHTML = `<div class="carousel-item active"><div class="debt-carousel-item">No current debts</div></div>`;
            return;
        }
        carouselInner.innerHTML = currentDebts.map((debt, index) => `
            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                <div class="debt-carousel-item">
                    <span class="client-name">${debt.clientName}</span> - Contact: ${debt.clientPhone || debt.clientEmail || 'N/A'}
                </div>
            </div>
        `).join('');
    }
    // =================================================================
    // FONCTIONS D'EXPORTATION
    // =================================================================
    function exportDataToCSV() {
        const startDate = document.getElementById('filter-date-start').value;
        const endDate = document.getElementById('filter-date-end').value;
        const filteredData = filterDataByDate(startDate, endDate, 'all', 'all');
        const stats = calculateDashboardStats(filteredData);
        let csvContent = "Alpha Pro Report - " + new Date().toLocaleDateString('fr-FR') + "\n";
        csvContent += "Net Profit," + formatCurrency(stats.netProfit) + "\n";
        csvContent += "Sales Revenue," + formatCurrency(stats.totalSales) + "\n";
        csvContent += "Quantity Sold," + stats.qtySold + "\n";
        csvContent += "Total Debts," + formatCurrency(stats.totalDebtsDue) + "\n";
        csvContent += "Total Expenses," + formatCurrency(stats.totalExpenses) + "\n";
        csvContent += "Gross Margin," + formatCurrency(stats.grossMargin) + "\n";
        csvContent += "Net Margin," + formatCurrency(stats.netMargin) + "\n";
        downloadCSV(csvContent, 'alpha_pro_report.csv');
    }
    function exportProductsToCSV() {
        let csvContent = "Name,Category,Specs,Quantity,Purchase Price,Sale Price,Stock Alert\n";
        data.products.forEach(product => {
            const category = getCategoryName(product.categoryId);
            csvContent += `"${product.name}","${category}","${product.specs || ''}",${product.qty},${product.buyPrice},${product.salePrice},${product.alertQty}\n`;
        });
        downloadCSV(csvContent, 'alpha_pro_products.csv');
    }
    function exportSalesToCSV() {
        let csvContent = "Date,Time,Client,Products,Quantity,Total Price,Gross Margin,Net Margin,Status\n";
        data.sales.forEach(sale => {
            const productNames = sale.items.map(item => `${item.name} (x${item.qty})`).join(', ');
            const firstItem = sale.items[0];
            const product = firstItem ? getProductById(firstItem.id) : null;
            const costOfFirstItem = product ? (product.buyPrice * firstItem.qty) : 0;
            const grossMargin = sale.total - costOfFirstItem;
            const netMargin = grossMargin - (sale.productExpense || 0);
            const status = sale.isDebt ? 'Crédit' : 'Espèces';
            csvContent += `"${sale.date}","${sale.time}","${sale.clientName}","${productNames}",${sale.items.reduce((sum, item) => sum + item.qty, 0)},${sale.total},${grossMargin},${netMargin},"${status}"\n`;
        });
        downloadCSV(csvContent, 'alpha_pro_sales.csv');
    }
    function exportDebtsToCSV() {
        let csvContent = "Client,Due Date,Initial Amount,Remaining\n";
        data.debts.filter(d => d.remaining > 0).forEach(debt => {
            csvContent += `"${debt.clientName}","${debt.dueDate}",${debt.initialAmount},${debt.remaining}\n`;
        });
        downloadCSV(csvContent, 'alpha_pro_debts.csv');
    }
    function exportExpensesToCSV() {
        let csvContent = "Date,Description,Category,Amount\n";
        data.expenses.forEach(expense => {
            csvContent += `"${expense.date}","${expense.description}","${expense.category}",${expense.amount}\n`;
        });
        downloadCSV(csvContent, 'alpha_pro_expenses.csv');
    }
    function downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    function exportDashboardPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const margin = 10;
        let y = margin;
        const pageWidth = doc.internal.pageSize.getWidth();
        doc.setFontSize(18);
        doc.text("Alpha Pro Dashboard Report", pageWidth / 2, y, { align: 'center' });
        y += 10;
        html2canvas(document.getElementById('dashboard-container-kpis')).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = pageWidth - 2 * margin;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            doc.addImage(imgData, 'PNG', margin, y, imgWidth, imgHeight);
            y += imgHeight + 5;
            doc.setFontSize(12);
            doc.text("Statistiques détaillées et graphiques non inclus dans l'exportation simple.", margin, y + 5);
            doc.save('AlphaPro_Dashboard_Report.pdf');
        }).catch(error => {
            console.error("Error generating PDF: ", error);
            alert("Erreur lors de la génération du PDF.");
        });
    }
    // =================================================================
    // GRAPHIQUES (CHART.JS)
    // =================================================================
    const COLOR_PALETTE = {
        primary: 'rgb(102, 126, 234)', 
        secondary: 'rgb(118, 75, 162)',
        success: 'rgb(104, 211, 145)', 
        danger: 'rgb(252, 129, 129)', 
        warning: 'rgb(246, 173, 85)', 
        info: 'rgb(99, 179, 237)'
    };
    function updateProfitChart(filteredData) {
        const ctx = document.getElementById('profitChart')?.getContext('2d');
        if (!ctx) return;
        if (charts.profitChart) charts.profitChart.destroy();
        const monthlyData = [...filteredData.sales, ...filteredData.expenses].reduce((acc, item) => {
            if (!item.date) return acc;
            const monthYear = item.date.slice(0, 7);
            if (!acc[monthYear]) acc[monthYear] = { revenue: 0, costOfSales: 0, expenses: 0 };
            if (item.items) { // Vente (nouvelle structure)
                acc[monthYear].revenue += item.total;
                let costOfSale = 0;
                item.items.forEach(i => {
                    const product = getProductById(i.id);
                    if (product) costOfSale += product.buyPrice * i.qty;
                });
                costOfSale += (item.productExpense || 0);
                acc[monthYear].costOfSales += costOfSale;
            } else if (item.amount) { // Dépense
                acc[monthYear].expenses += item.amount;
            }
            return acc;
        }, {});
        const labels = Object.keys(monthlyData).sort();
        const profit = labels.map(key => monthlyData[key].revenue - monthlyData[key].costOfSales - monthlyData[key].expenses);
        const totalExpenses = labels.map(key => monthlyData[key].costOfSales + monthlyData[key].expenses);
        charts.profitChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
	                    {
	                        label: 'Bénéfice Net',
	                        data: profit,
	                        borderColor: COLOR_PALETTE.success,
	                        backgroundColor: 'rgba(104, 211, 145, 0.2)',
	                        fill: true,
	                        tension: 0.4
	                    },
	                    {
	                        label: 'Coûts Totaux',
	                        data: totalExpenses,
	                        borderColor: COLOR_PALETTE.danger,
	                        backgroundColor: 'rgba(252, 129, 129, 0.2)',
	                        fill: false,
	                        tension: 0.4
	                    }
                ]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`,
                        }
                    }
                }
            }
        });
    }
    function updateExpenseCategoryChart(filteredData) {
        const ctx = document.getElementById('expenseCategoryChart')?.getContext('2d');
        if (!ctx) return;
        if (charts.expenseCategoryChart) charts.expenseCategoryChart.destroy();
        const expenseData = filteredData.expenses.reduce((acc, exp) => {
            const category = exp.category || 'Autres';
            acc[category] = (acc[category] || 0) + exp.amount;
            return acc;
        }, {});
        charts.expenseCategoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(expenseData),
                datasets: [{
                    data: Object.values(expenseData),
                    backgroundColor: [COLOR_PALETTE.danger, COLOR_PALETTE.warning, COLOR_PALETTE.info, COLOR_PALETTE.primary, COLOR_PALETTE.secondary],
                    hoverOffset: 4
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.label}: ${formatCurrency(context.parsed)}`,
                        }
                    }
                }
            }
        });
    }
    function updateStockByCategoryChart() {
        const ctx = document.getElementById('stockByCategoryChart')?.getContext('2d');
        if (!ctx) return;
        if (charts.stockByCategoryChart) charts.stockByCategoryChart.destroy();
        const stockData = data.products.reduce((acc, product) => {
            const categoryName = getCategoryName(product.categoryId);
            acc[categoryName] = (acc[categoryName] || 0) + product.qty;
            return acc;
        }, {});
        charts.stockByCategoryChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(stockData),
                datasets: [{
                    label: 'Stock Total (Unités)',
                    data: Object.values(stockData),
                    backgroundColor: COLOR_PALETTE.info,
                    borderColor: '#4299e1',
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    // =================================================================
    // FONCTIONS UTILITAIRES
    // =================================================================
    
    function numberToWords(num) {
        if (num === 0) return 'Zéro';
        const units = ['', 'Un', 'Deux', 'Trois', 'Quatre', 'Cinq', 'Six', 'Sept', 'Huit', 'Neuf'];
        const teens = ['Dix', 'Onze', 'Douze', 'Treize', 'Quatorze', 'Quinze', 'Seize', 'Dix-sept', 'Dix-huit', 'Dix-neuf'];
        const tens = ['', '', 'Vingt', 'Trente', 'Quarante', 'Cinquante', 'Soixante', 'Soixante-dix', 'Quatre-vingts', 'Quatre-vingt-dix'];
        const scales = ['', 'Mille', 'Million', 'Milliard'];

        function convertThreeDigits(n) {
            let str = '';
            const unit = n % 10;
            const ten = Math.floor((n % 100) / 10);
            const hundred = Math.floor(n / 100);
            if (hundred) {
                str += (hundred === 1 ? '' : units[hundred] + ' ') + 'Cent ';
            }
            if (ten === 1) {
                str += teens[unit];
            } else {
                if (ten) str += tens[ten];
                if (unit) {
                    if (ten > 1) str += (unit === 1 && ten < 7 ? ' et ' : '-');
                    str += units[unit].toLowerCase();
                }
            }
            return str.trim();
        }

        let words = '';
        let scaleIndex = 0;
        let tempNum = Math.floor(num);
        
        while (tempNum > 0) {
            const chunk = tempNum % 1000;
            if (chunk !== 0) {
                let chunkWords = convertThreeDigits(chunk);
                if (scaleIndex === 1 && chunk === 1) chunkWords = '';
                words = chunkWords + (scales[scaleIndex] ? ' ' + scales[scaleIndex] : '') + (words ? ' ' + words : '');
            }
            tempNum = Math.floor(tempNum / 1000);
            scaleIndex++;
        }
        return words.trim() + ' Francs CFA';
    }
    // =================================================================
    // SAUVEGARDE AUTOMATIQUE QUOTIDIENNE
    // =================================================================
    function scheduleDailyBackup() {
        const now = new Date();
        // Calculer le temps jusqu'à minuit
        const midnight = new Date();
        midnight.setHours(24, 0, 0, 0);
        const msUntilMidnight = midnight - now;
        console.log(`Next backup scheduled in ${msUntilMidnight/1000/60} minutes`);
        setTimeout(() => {
            if (currentUser) {
                console.log('Automatic daily backup in progress...');
                saveUserData();
                // Reprogrammer pour le lendemain
                scheduleDailyBackup();
            }
        }, msUntilMidnight);
    }
    // =================================================================
    // DARK MODE TOGGLE
    // =================================================================
    function toggleDarkMode() {
        const root = document.documentElement;
        const isDarkMode = root.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
        const toggleBtn = document.getElementById('dark-mode-toggle');
        if (toggleBtn) {
            toggleBtn.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }
    }

    function loadDarkModePreference() {
        const darkModePreference = localStorage.getItem('darkMode');
        if (darkModePreference === 'enabled') {
            document.documentElement.classList.add('dark-mode');
            const toggleBtn = document.getElementById('dark-mode-toggle');
            if (toggleBtn) {
                toggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }
    }

    // =================================================================
    // DÉMARRAGE DE L'APPLICATION
    // =================================================================
    async function initApp() {
        try {
            // Charger la préférence Dark Mode
            loadDarkModePreference();
            // Initialiser les événements
            document.getElementById('login-form').addEventListener('submit', login);
            // Initialiser les dates
            const today = new Date().toISOString().slice(0, 10);
            if (document.getElementById('filter-date-end')) {
                document.getElementById('filter-date-end').value = today;
            }
            if (document.getElementById('expense-date')) {
                document.getElementById('expense-date').value = today;
            }
            if (document.getElementById('debt-due-date')) {
                document.getElementById('debt-due-date').value = today;
            }
            if (document.getElementById('analytics-date-end')) {
                document.getElementById('analytics-date-end').value = today;
            }
            // Vérifier l'authentification
            await checkAuth();
            // Programmer la sauvegarde quotidienne
            scheduleDailyBackup();
        } catch (error) {
            console.error("Critical error during initialization:", error);
            alert("Critical error at startup. Check the console (F12) for details.");
        }
    }
    // Démarrer l'application
    document.addEventListener('DOMContentLoaded', initApp);
    // Sauvegarde automatique toutes les 30 secondes
    setInterval(() => {
        if (currentUser) {
            persistData();
        }
    }, 30000);
    // Sauvegarde avant fermeture de la page
    window.addEventListener('beforeunload', () => {
        if (currentUser) {
            persistData();
        }
    });
</script>
</body>
</html>