<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AB-APP V4.1: ERP & SaaS Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.24/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="utils.js"></script>
    <script src="app.js"></script>
    <style>
        :root {
            --soft-bg: #f8fafc;
            --soft-glass: rgba(255, 255, 255, 0.9);
            --primary-accent: #667eea;
            --secondary-accent: #764ba2;
            --danger-color: #fc8181;
            --success-color: #68d391;
        }
        :root.dark-mode {
            --soft-bg: #1a202c;
            --soft-glass: rgba(30, 41, 59, 0.9);
        }
        body {
            background: linear-gradient(135deg, var(--soft-bg) 0%, #e2e8f0 100%);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .glass-card {
            background: var(--soft-glass);
            backdrop-filter: blur(15px);
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .login-container {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-accent), var(--secondary-accent));
        }
        .admin-only { display: none; }
        .vendeuse-restricted { pointer-events: none; opacity: 0.7; }
        #app-container { display: none; }
        .navbar { backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 1000; }
    </style>
</head>
<body>
    <!-- PAGE DE CONNEXION -->
    <div id="login-page" class="login-container">
        <div class="glass-card p-5 text-center" style="width: 400px;">
            <h2 class="mb-4">AB-APP V4.1</h2>
            <div class="mb-3">
                <input type="text" id="login-username" class="form-control" placeholder="Nom d'utilisateur">
            </div>
            <div class="mb-3">
                <input type="password" id="login-password" class="form-control" placeholder="Mot de passe">
            </div>
            <button class="btn btn-primary w-100" onclick="handleLogin()">Se connecter</button>
            <p class="mt-3 text-muted small">7 comptes vendeuses + 1 Admin par défaut</p>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE -->
    <div id="app-container">
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
            <div class="container">
                <a class="navbar-brand fw-bold" href="#">
                    <img id="nav-logo" src="" alt="" style="height: 30px; margin-right: 10px;">
                    <span id="nav-company-name">AB-APP V4.1</span>
                </a>
                <div class="d-flex align-items-center">
                    <span id="user-display-name" class="me-3 fw-bold"></span>
                    <button class="btn btn-outline-danger btn-sm" onclick="logout()">Déconnexion</button>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <!-- DASHBOARD -->
            <div id="dashboard-section" class="row g-4">
                <div class="col-md-3">
                    <div class="glass-card p-4 text-center">
                        <h6>Ventes du jour</h6>
                        <h3 id="kpi-daily-sales">0 FCFA</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-card p-4 text-center">
                        <h6>Stock Total</h6>
                        <h3 id="kpi-total-stock">0</h3>
                    </div>
                </div>
                <div class="col-md-3 admin-only">
                    <div class="glass-card p-4 text-center">
                        <h6>Bénéfice Net</h6>
                        <h3 id="kpi-profit">0 FCFA</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-card p-4 text-center">
                        <h6>Dettes Clients</h6>
                        <h3 id="kpi-debts">0 FCFA</h3>
                    </div>
                </div>
            </div>

            <!-- SECTION VENTES -->
            <div class="row mt-5">
                <div class="col-md-8">
                    <div class="glass-card p-4">
                        <h4 class="mb-4">Nouvelle Vente</h4>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Sélectionner Client (Obligatoire)</label>
                                <select id="sale-client-select" class="form-select" required>
                                    <option value="">-- Choisir un client --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Type de Paiement</label>
                                <select id="sale-payment-type" class="form-select">
                                    <option value="cash">Espèces</option>
                                    <option value="om">Orange Money</option>
                                    <option value="momo">Moov Money</option>
                                    <option value="debt">Dette / Crédit</option>
                                </select>
                            </div>
                        </div>
                        <div id="cart-items" class="mb-4">
                            <!-- Items du panier -->
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 id="cart-total">Total: 0 FCFA</h3>
                            <button class="btn btn-success btn-lg" onclick="processSale()">Valider la Vente</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="glass-card p-4">
                        <h4 class="mb-4">Actions Rapides</h4>
                        <button class="btn btn-primary w-100 mb-2" onclick="exportData('sales')">Exporter Ventes (Excel)</button>
                        <button class="btn btn-info w-100 mb-2 admin-only" onclick="showStockModal()">Gérer le Stock</button>
                        <button class="btn btn-warning w-100 mb-2" onclick="showClientModal()">Ajouter Client</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL FACTURE (HIDDEN) -->
    <div id="invoice-template" style="display:none;">
        <div id="invoice-content" style="padding: 40px; background: white; width: 800px;">
            <div class="d-flex justify-content-between">
                <div>
                    <img id="invoice-logo" src="" style="max-height: 80px;">
                    <h2 id="invoice-company-name"></h2>
                </div>
                <div class="text-end">
                    <h4>FACTURE N° <span id="invoice-id"></span></h4>
                    <p>Date: <span id="invoice-date"></span></p>
                </div>
            </div>
            <hr>
            <table class="table">
                <thead>
                    <tr><th>Produit</th><th>Qté</th><th>Prix</th><th>Total</th></tr>
                </thead>
                <tbody id="invoice-items"></tbody>
            </table>
            <div class="text-end">
                <h5>Total: <span id="invoice-total"></span> FCFA</h5>
                <h5>Versé: <span id="invoice-paid"></span> FCFA</h5>
                <h5 id="invoice-remaining-row" style="color: red;">Reste à payer: <span id="invoice-remaining"></span> FCFA</h5>
                <p class="mt-3"><strong>Montant en lettres:</strong> <span id="invoice-amount-letters"></span></p>
            </div>
        </div>
    </div>
</body>
</html>
